<!-- D7 â€” Prevent Recurrence -->
<div class="space-y-6" x-data="{ expandedAction: null }">

  <!-- Preventive Actions Card -->
  <div class="ds-card">
    <div class="ds-card__header">
      <h3 class="ds-h3">7A. Preventive Actions</h3>
      <p class="ds-caption">Define systemic changes to prevent recurrence of this and similar problems.</p>
    </div>
    <div class="ds-card__body">
      <div class="overflow-x-auto">
        <table id="d7-preventive-actions" class="ds-table w-full">
          <thead class="text-sm">
            <tr>
              <th>Action</th>
              <th>Type</th>
              <th>Available</th>
              <th>Responsible</th>
              <th>Target Date</th>
              <th>Status</th>
              <th>History</th>
              <th>Revised RPN</th>
              <th class="w-12"></th>
            </tr>
          </thead>
          <tbody>
            <!-- Rows will be injected by JS -->
          </tbody>
          <tfoot>
            <tr>
              <td colspan="9"><button class="add-row-btn ds-btn ds-btn--tertiary w-full"><i data-lucide="plus"></i> Add Preventive Action</button></td>
            </tr>
          </tfoot>
          <template>
            <tr>
              <td><textarea class="ds-textarea" placeholder="Description of preventive measure"></textarea></td>
              <td>
                <select class="ds-select">
                  <option>Corrective</option>
                  <option>Preventive</option>
                  <option>Detective</option>
                </select>
              </td>
              <td>
                <select class="ds-select">
                  <option>Yes</option>
                  <option>No</option>
                  <option>Partial</option>
                </select>
              </td>
              <td><input class="ds-input" placeholder="Assigned owner"/></td>
              <td><input class="ds-input" type="date"/></td>
              <td>
                <select class="ds-select">
                  <option>Open</option>
                  <option>In Progress</option>
                  <option>Completed</option>
                  <option>Overdue</option>
                </select>
              </td>
              <td><button class="ds-btn ds-btn--secondary ds-btn--sm w-full"><i data-lucide="history"></i> View</button></td>
              <td><input class="ds-input" type="number" placeholder="RPN"/></td>
              <td><button class="remove-row-btn ds-btn-icon ds-btn-icon--danger"><i data-lucide="trash-2"></i></button></td>
            </tr>
          </template>
        </table>
      </div>
    </div>
  </div>

  <!-- Acknowledgement Card -->
  <div class="ds-card">
    <div class="ds-card__header">
      <h3 class="ds-h3">Read & Understood</h3>
    </div>
    <div class="ds-card__body flex justify-between items-center">
      <div class="flex items-center gap-2">
        <div id="d7-avatar-stack" class="flex -space-x-2">
            <!-- Avatars will be injected by JS -->
        </div>
        <div id="d7-ack-bar" class="text-sm text-slate-600">0 of 0 acknowledged</div>
      </div>
      <button id="d7-view-acks" class="ds-btn ds-btn--secondary"><i data-lucide="users"></i> View Details</button>
    </div>
  </div>
</div>

<!-- Acknowledgement Modal -->
<div id="d7-ack-modal" class="fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50 hidden">
  <div class="ds-card w-full max-w-lg">
    <div class="ds-card__header flex justify-between items-center">
      <h3 class="ds-h3">Acknowledgement Status</h3>
      <button id="d7-modal-close" class="ds-btn-icon" aria-label="Close">
        <i data-lucide="x"></i>
      </button>
    </div>
    <div class="ds-card__body max-h-[60vh] overflow-y-auto">
      <ul id="d7-ack-list" class="space-y-2">
        <!-- List items will be injected by JS -->
      </ul>
    </div>
    <div class="ds-card__body border-t flex justify-end">
      <button id="d7-ack-me" class="ds-btn ds-btn--primary">Acknowledge Now</button>
    </div>
  </div>
</div>


<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script>
  if (window.__init8D) {
    window.__init8D(document);
  }

  (function() {
    // Function to calculate the revised RPN score in the D7 details card
    function calculateD7Rpn() {
      const detailCard = document.getElementById('d7-detail');
      if (!detailCard) return;

      const s = parseInt(detailCard.querySelector('.rpn-s')?.value, 10) || 0;
      const o = parseInt(detailCard.querySelector('.rpn-o')?.value, 10) || 0;
      const d = parseInt(detailCard.querySelector('.rpn-d')?.value, 10) || 0;
      const scoreEl = detailCard.querySelector('#d7-rpn-val');

      if (scoreEl) {
        scoreEl.textContent = s * o * d;
      }
    }

    // Use event delegation on the details card to listen for input changes
    const detailCard = document.getElementById('d7-detail');
    if (detailCard) {
      detailCard.addEventListener('input', function(event) {
        const target = event.target;
        if (target.matches('.rpn-s, .rpn-o, .rpn-d')) {
          calculateD7Rpn();
        }
      });
    }

    // Also, ensure the calculation runs when the details card is shown,
    // in case it's populated with data before being displayed.
    const observer = new MutationObserver(function(mutations) {
        for (let mutation of mutations) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                if (detailCard.style.display !== 'none') {
                    calculateD7Rpn();
                }
            }
        }
    });

    if(detailCard) {
      observer.observe(detailCard, { attributes: true });
    }

    // --- Acknowledgement Tracking Logic ---
    const ackModal = document.getElementById('d7-ack-modal');
    const viewBtn = document.getElementById('d7-view-acks');
    const closeBtn = document.getElementById('d7-modal-close');
    const ackMeBtn = document.getElementById('d7-ack-me');
    const ackList = document.getElementById('d7-ack-list');
    const ackBar = document.getElementById('d7-ack-bar');
    const avatarStack = document.getElementById('d7-avatar-stack');

    if (ackModal && viewBtn && closeBtn && ackMeBtn && ackList && ackBar && avatarStack) {
      // This would normally come from window.app.data.d7.acknowledgements
      let acknowledgements = new Set(['samantha.jones@example.com']);

      // This would come from window.app.data.d1.fields.members
      const teamMembers = [
        { name: 'Alex Vance', email: 'alex.vance@example.com' },
        { name: 'Samantha Jones', email: 'samantha.jones@example.com' },
        { name: 'Brad Carter', email: 'brad.carter@example.com' },
        { name: 'Maria Garcia', email: 'maria.garcia@example.com' },
      ];

      // Assuming the current user's email is stored somewhere, e.g., localStorage
      const currentUserEmail = 'alex.vance@example.com';

      function renderAckStatus() {
        // Render modal list
        ackList.innerHTML = '';
        teamMembers.forEach(member => {
          const isAcked = acknowledgements.has(member.email);
          const li = document.createElement('li');
          li.className = 'flex items-center justify-between p-2 rounded-md';
          li.innerHTML = `
            <span class="font-semibold text-slate-700">${member.name}</span>
            ${isAcked
              ? '<span class="flex items-center gap-1 text-emerald-600"><i data-lucide="check-circle-2" class="w-4 h-4"></i>Acknowledged</span>'
              : '<span class="text-xs text-slate-500">Pending</span>'
            }
          `;
          ackList.appendChild(li);
        });

        // Render summary bar
        ackBar.textContent = `${acknowledgements.size} of ${teamMembers.length} acknowledged`;

        // Render avatar stack
        avatarStack.innerHTML = '';
        teamMembers.filter(m => acknowledgements.has(m.email)).slice(0, 5).forEach(m => {
          const initials = m.name.split(' ').map(n => n[0]).join('');
          const span = document.createElement('span');
          span.className = 'inline-flex items-center justify-center h-8 w-8 rounded-full bg-emerald-200 text-emerald-700 font-bold text-xs ring-2 ring-white';
          span.textContent = initials;
          span.title = m.name;
          avatarStack.appendChild(span);
        });

        // Update button state
        ackMeBtn.disabled = acknowledgements.has(currentUserEmail);
        ackMeBtn.textContent = acknowledgements.has(currentUserEmail) ? 'Acknowledged' : 'Acknowledge Now';

        if(window.lucide) window.lucide.createIcons();
      }

      viewBtn.addEventListener('click', () => {
        renderAckStatus();
        ackModal.classList.remove('hidden');
      });

      closeBtn.addEventListener('click', () => ackModal.classList.add('hidden'));
      ackModal.addEventListener('click', (e) => {
        if (e.target === ackModal) ackModal.classList.add('hidden');
      });

      ackMeBtn.addEventListener('click', () => {
        if (!acknowledgements.has(currentUserEmail)) {
          acknowledgements.add(currentUserEmail);
          // In a real app, you would save this back to window.app.data
          renderAckStatus();
        }
      });

      // Initial render for the summary bar
      renderAckStatus();
    }
  })();
</script>