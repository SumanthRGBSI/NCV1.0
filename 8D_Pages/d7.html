<!-- D7 â€” Prevent Recurrence -->
<div class="space-y-6" x-data="{ expandedAction: null }">

  <!-- Preventive Actions Card -->
  <div class="ds-card">
    <div class="ds-card__header">
      <h3 class="ds-h3">7A. Preventive Actions</h3>
      <p class="ds-caption">Define systemic changes to prevent recurrence of this and similar problems.</p>
    </div>
    <div class="ds-card__body">
      <div class="overflow-x-auto">
        <table id="d7-preventive-actions" class="ds-table w-full">
          <thead class="text-sm">
            <tr>
              <th>Action</th>
              <th>Type</th>
              <th>Available</th>
              <th>Responsible</th>
              <th>Target Date</th>
              <th>Status</th>
              <th>History</th>
              <th>Revised RPN</th>
              <th class="w-12"></th>
            </tr>
          </thead>
          <tbody>
            <!-- Rows will be injected by JS -->
          </tbody>
          <tfoot>
            <tr>
              <td colspan="9"><button class="add-row-btn ds-btn ds-btn--tertiary w-full"><i data-lucide="plus"></i> Add Preventive Action</button></td>
            </tr>
          </tfoot>
          <template>
            <tr>
              <td><textarea class="ds-textarea pa-action" placeholder="Description of preventive measure"></textarea></td>
              <td>
                <select class="ds-select pa-type">
                  <option>Corrective</option>
                  <option>Preventive</option>
                  <option>Detective</option>
                </select>
              </td>
              <td class="text-center">
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" class="sr-only peer pa-available">
                  <div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-500"></div>
                </label>
              </td>
              <td><input class="ds-input pa-responsible" placeholder="Assigned owner"/></td>
              <td><input class="ds-input pa-target-date" type="date"/></td>
              <td>
                <select class="ds-select pa-status">
                  <option>Open</option>
                  <option>In Progress</option>
                  <option>Completed</option>
                  <option>Overdue</option>
                </select>
              </td>
              <td><button class="ds-btn ds-btn--secondary ds-btn--sm w-full"><i data-lucide="history"></i> View</button></td>
              <td><input class="ds-input pa-rpn" type="number" placeholder="RPN"/></td>
              <td><button class="remove-row-btn ds-btn-icon ds-btn-icon--danger"><i data-lucide="trash-2"></i></button></td>
            </tr>
          </template>
        </table>
      </div>
    </div>
  </div>

  <!-- Acknowledgement Card -->
  <div class="ds-card">
    <div class="ds-card__header">
      <h3 class="ds-h3">Read & Understood</h3>
    </div>
    <div class="ds-card__body flex justify-between items-center">
      <div class="flex items-center gap-2">
        <div id="d7-avatar-stack" class="flex -space-x-2">
            <!-- Avatars will be injected by JS -->
        </div>
        <div id="d7-ack-bar" class="text-sm text-slate-600">0 of 0 acknowledged</div>
      </div>
      <button id="d7-view-acks" class="ds-btn ds-btn--secondary"><i data-lucide="users"></i> View Details</button>
    </div>
  </div>
</div>

<!-- Confirm Delete Modal -->
<div id="confirm-delete-modal" class="fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50 hidden">
  <div class="ds-card w-full max-w-md">
    <div class="ds-card__header">
      <h3 class="ds-h3">Confirm Deletion</h3>
    </div>
    <div class="ds-card__body">
      <p>Are you sure you want to delete this item? This action cannot be undone.</p>
    </div>
    <div class="ds-card__body border-t flex justify-end gap-2">
      <button id="cancel-delete-btn" class="ds-btn ds-btn--secondary">Cancel</button>
      <button id="confirm-delete-btn" class="ds-btn ds-btn--danger">Delete</button>
    </div>
  </div>
</div>


<!-- Acknowledgement Modal -->
<div id="d7-ack-modal" class="fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50 hidden">
  <div class="ds-card w-full max-w-lg">
    <div class="ds-card__header flex justify-between items-center">
      <h3 class="ds-h3">Acknowledgement Status</h3>
      <button id="d7-modal-close" class="ds-btn-icon" aria-label="Close">
        <i data-lucide="x"></i>
      </button>
    </div>
    <div class="ds-card__body max-h-[60vh] overflow-y-auto">
      <ul id="d7-ack-list" class="space-y-2">
        <!-- List items will be injected by JS -->
      </ul>
    </div>
    <div class="ds-card__body border-t flex justify-end">
      <button id="d7-ack-me" class="ds-btn ds-btn--primary">Acknowledge Now</button>
    </div>
  </div>
</div>


<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script>
(function() {
    if (window.d7Initialized) return;
    window.d7Initialized = true;

    function qs(selector, context = document) { return context.querySelector(selector); }

    function initializeD7Logic(context) {
        const ackModal = qs('#d7-ack-modal', context);
        const viewBtn = qs('#d7-view-acks', context);
        const closeBtn = qs('#d7-modal-close', context);
        const ackMeBtn = qs('#d7-ack-me', context);
        const ackList = qs('#d7-ack-list', context);
        const ackBar = qs('#d7-ack-bar', context);
        const avatarStack = qs('#d7-avatar-stack', context);

        function renderPreventiveActions() {
            const tbody = qs('#d7-preventive-actions tbody', context);
            const template = qs('#d7-preventive-actions template', context);
            const actions = window.app?.data?.d7?.fields?.preventiveActions || [];

            if (!tbody || !template) return;
            tbody.innerHTML = '';

            actions.forEach((item, index) => {
                const row = template.content.cloneNode(true);
                row.firstElementChild.dataset.index = index;
                qs('.pa-action', row).value = item.action || '';
                qs('.pa-type', row).value = item.type || 'Corrective';
                qs('.pa-available', row).checked = !!item.available;
                qs('.pa-responsible', row).value = item.responsible || '';
                qs('.pa-target-date', row).value = item.targetDate || '';
                qs('.pa-status', row).value = item.status || 'Open';
                qs('.pa-rpn', row).value = item.rpn || '';
                tbody.appendChild(row);
            });
        }

        function setupDeleteConfirmation() {
            const container = qs('#d7-preventive-actions', context);
            const modal = qs('#confirm-delete-modal');
            const confirmBtn = qs('#confirm-delete-btn', modal);
            const cancelBtn = qs('#cancel-delete-btn', modal);
            let rowToDelete = null;

            if (!container || !modal) return;

            container.addEventListener('click', e => {
                const removeBtn = e.target.closest('.remove-row-btn');
                if (removeBtn) {
                    rowToDelete = removeBtn.closest('tr');
                    modal.classList.remove('hidden');
                }
            });

            cancelBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
                rowToDelete = null;
            });

            confirmBtn.addEventListener('click', () => {
                if (rowToDelete) {
                    const index = rowToDelete.dataset.index;
                    const actions = window.app.data.d7.fields.preventiveActions;
                    if (actions && actions[index]) {
                        actions.splice(index, 1);
                        window.app.saveData('d7-preventive-actions-delete');
                        renderPreventiveActions();
                    }
                }
                modal.classList.add('hidden');
                rowToDelete = null;
            });
        }

        function renderAckStatus() {
            if (!ackModal) return;

            const teamMembers = window.app?.data?.d1?.fields?.members || [];
            const acknowledgedEmails = new Set(window.app?.data?.d7?.fields?.acknowledgements || []);
            const currentUserEmail = window.app?.data?.meta?.userEmail || 's.jenkins@example.com'; // Fallback for demo

            // Render modal list
            ackList.innerHTML = '';
            teamMembers.forEach(member => {
                const isAcked = acknowledgedEmails.has(member.email);
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-2 rounded-md';
                li.innerHTML = `<span class="font-semibold text-slate-700">${member.name}</span>
                    ${isAcked ? '<span class="flex items-center gap-1 text-emerald-600"><i data-lucide="check-circle-2" class="w-4 h-4"></i>Acknowledged</span>' : '<span class="text-xs text-slate-500">Pending</span>'}`;
                ackList.appendChild(li);
            });

            // Render summary bar
            ackBar.textContent = `${acknowledgedEmails.size} of ${teamMembers.length} acknowledged`;

            // Render avatar stack
            avatarStack.innerHTML = '';
            teamMembers.filter(m => acknowledgedEmails.has(m.email)).slice(0, 5).forEach(m => {
                const initials = m.name.split(' ').map(n => n[0]).join('');
                const span = document.createElement('span');
                span.className = 'inline-flex items-center justify-center h-8 w-8 rounded-full bg-emerald-200 text-emerald-700 font-bold text-xs ring-2 ring-white';
                span.textContent = initials;
                span.title = m.name;
                avatarStack.appendChild(span);
            });

            // Update button state
            ackMeBtn.disabled = acknowledgedEmails.has(currentUserEmail);
            ackMeBtn.textContent = acknowledgedEmails.has(currentUserEmail) ? 'Acknowledged' : 'Acknowledge Now';

            if (window.lucide) window.lucide.createIcons();
        }

        function renderAll() {
            renderPreventiveActions();
            renderAckStatus();
        }

        if (viewBtn && !viewBtn.dataset.listenerAttached) {
            viewBtn.addEventListener('click', () => {
                renderAckStatus();
                ackModal.classList.remove('hidden');
            });
            closeBtn.addEventListener('click', () => ackModal.classList.add('hidden'));
            ackModal.addEventListener('click', e => { if (e.target === ackModal) ackModal.classList.add('hidden'); });

            ackMeBtn.addEventListener('click', () => {
                const currentUserEmail = window.app?.data?.meta?.userEmail || 's.jenkins@example.com';
                const acks = window.app.data.d7.fields.acknowledgements;
                if (acks && !acks.includes(currentUserEmail)) {
                    acks.push(currentUserEmail);
                    window.app.saveData('d7-ack');
                    renderAckStatus();
                }
            });
            viewBtn.dataset.listenerAttached = 'true';
        }

        document.addEventListener('appDataReady', renderAll, { once: true });
        if (window.app && window.app.data) {
            renderAll();
        }

        setupDeleteConfirmation();
    }

    const originalInit = window.__init8D;
    window.__init8D = function(context) {
        if(originalInit) originalInit(context);
        if(qs('#d7-preventive-actions', context)) {
            initializeD7Logic(context);
        }
    };

    if(qs('#d7-preventive-actions')) {
        initializeD7Logic(document);
    }
})();
</script>