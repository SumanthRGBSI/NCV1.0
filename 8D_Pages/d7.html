<!-- D7 â€” Prevent Recurrence -->
<div class="space-y-6" x-data="{ expandedAction: null }">

  <!-- Preventive Actions Card -->
  <div class="ds-card">
    <div class="ds-card__header">
      <h3 class="ds-h3">7A. Preventive Actions</h3>
      <p class="ds-caption">Define systemic changes to prevent recurrence of this and similar problems.</p>
    </div>
    <div class="ds-card__body">
      <div class="overflow-x-auto">
        <table id="d7-preventive-actions" class="ds-table w-full">
          <thead class="text-sm">
            <tr>
              <th>Action</th>
              <th>Type</th>
              <th>Available</th>
              <th>Responsible</th>
              <th>Target Date</th>
              <th>Status</th>
              <th>History</th>
              <th>Revised RPN</th>
              <th class="w-12"></th>
            </tr>
          </thead>
          <tbody>
            <!-- Rows will be injected by JS -->
          </tbody>
          <tfoot>
            <tr>
              <td colspan="9"><button class="add-row-btn ds-btn ds-btn--tertiary w-full"><i data-lucide="plus"></i> Add Preventive Action</button></td>
            </tr>
          </tfoot>
          <template>
            <tr>
              <td><textarea class="ds-textarea pa-action" placeholder="Description of preventive measure"></textarea></td>
              <td>
                <select class="ds-select pa-type">
                  <option>Corrective</option>
                  <option>Preventive</option>
                  <option>Detective</option>
                </select>
              </td>
              <td class="text-center">
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" class="sr-only peer pa-available">
                  <div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-500"></div>
                </label>
              </td>
              <td><input class="ds-input pa-responsible" placeholder="Assigned owner"/></td>
              <td><input class="ds-input pa-target-date" type="date"/></td>
              <td>
                <select class="ds-select pa-status">
                  <option>Open</option>
                  <option>In Progress</option>
                  <option>Completed</option>
                  <option>Overdue</option>
                </select>
              </td>
              <td><button class="ds-btn ds-btn--secondary ds-btn--sm w-full"><i data-lucide="history"></i> View</button></td>
              <td><input class="ds-input pa-rpn" type="number" placeholder="RPN"/></td>
              <td><button class="remove-row-btn ds-btn-icon ds-btn-icon--danger"><i data-lucide="trash-2"></i></button></td>
            </tr>
          </template>
        </table>
      </div>
    </div>
  </div>

  <!-- Acknowledgement Card -->
  <div class="ds-card">
    <div class="ds-card__header">
      <h3 class="ds-h3">Read & Understood</h3>
    </div>
    <div class="ds-card__body flex justify-between items-center">
      <div class="flex items-center gap-2">
        <div id="d7-avatar-stack" class="flex -space-x-2">
            <!-- Avatars will be injected by JS -->
        </div>
        <div id="d7-ack-bar" class="text-sm text-slate-600">0 of 0 acknowledged</div>
      </div>
      <button id="d7-view-acks" class="ds-btn ds-btn--secondary"><i data-lucide="users"></i> View Details</button>
    </div>
  </div>
</div>

<!-- Confirm Delete Modal -->
<div id="confirm-delete-modal" class="fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50 hidden">
  <div class="ds-card w-full max-w-md">
    <div class="ds-card__header">
      <h3 class="ds-h3">Confirm Deletion</h3>
    </div>
    <div class="ds-card__body">
      <p>Are you sure you want to delete this item? This action cannot be undone.</p>
    </div>
    <div class="ds-card__body border-t flex justify-end gap-2">
      <button id="cancel-delete-btn" class="ds-btn ds-btn--secondary">Cancel</button>
      <button id="confirm-delete-btn" class="ds-btn ds-btn--danger">Delete</button>
    </div>
  </div>
</div>


<!-- Acknowledgement Modal -->
<div id="d7-ack-modal" class="fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50 hidden">
  <div class="ds-card w-full max-w-lg">
    <div class="ds-card__header flex justify-between items-center">
      <h3 class="ds-h3">Acknowledgement Status</h3>
      <button id="d7-modal-close" class="ds-btn-icon" aria-label="Close">
        <i data-lucide="x"></i>
      </button>
    </div>
    <div class="ds-card__body max-h-[60vh] overflow-y-auto">
      <ul id="d7-ack-list" class="space-y-2">
        <!-- List items will be injected by JS -->
      </ul>
    </div>
    <div class="ds-card__body border-t flex justify-end">
      <button id="d7-ack-me" class="ds-btn ds-btn--primary">Acknowledge Now</button>
    </div>
  </div>
</div>


<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script>
(function() {
    if (window.d7Initialized) return;
    window.d7Initialized = true;

    function qs(selector, context = document) { return context.querySelector(selector); }
    function qsa(selector, context = document) { return Array.from(context.querySelectorAll(selector)); }

    function updateAppData() {
        if (!window.app || !window.app.data || !window.app.data.d7) return;
        const fields = window.app.data.d7.fields;

        fields.preventiveActions = qsa('#d7-preventive-actions tbody tr').map(tr => ({
            action: qs('.pa-action', tr).value,
            type: qs('.pa-type', tr).value,
            available: qs('.pa-available', tr).checked,
            responsible: qs('.pa-responsible', tr).value,
            targetDate: qs('.pa-target-date', tr).value,
            status: qs('.pa-status', tr).value,
            rpn: qs('.pa-rpn', tr).value
        }));

        window.app._dirty = true;
        if (window.app.updateSaveFab) window.app.updateSaveFab(true);
        if (window.app.saveData) {
            clearTimeout(window.d7SaveTimer);
            window.d7SaveTimer = setTimeout(() => window.app.saveData('d7-update'), 600);
        }
    }

    function render() {
        if (!window.app || !window.app.data || !window.app.data.d7) return;
        const fields = window.app.data.d7.fields;
        const context = document;

        if (!Array.isArray(fields.preventiveActions)) fields.preventiveActions = [];

        const tbody = qs('#d7-preventive-actions tbody', context);
        const template = qs('#d7-preventive-actions template', context);

        tbody.innerHTML = '';
        fields.preventiveActions.forEach((item, index) => {
            const row = template.content.cloneNode(true);
            qs('.pa-action', row).value = item.action || '';
            qs('.pa-type', row).value = item.type || 'Corrective';
            qs('.pa-available', row).checked = !!item.available;
            qs('.pa-responsible', row).value = item.responsible || '';
            qs('.pa-target-date', row).value = item.targetDate || '';
            qs('.pa-status', row).value = item.status || 'Open';
            qs('.pa-rpn', row).value = item.rpn || '';
            qs('.remove-row-btn', row).dataset.index = index;
            tbody.appendChild(row);
        });

        if (window.lucide) window.lucide.createIcons();
    }

    function initializeD7Logic(context) {
        const container = qs('.space-y-6', context);
        if (!container || container.dataset.d7ListenersAttached) return;

        container.addEventListener('click', e => {
            const addBtn = e.target.closest('.add-row-btn');
            const removeBtn = e.target.closest('.remove-row-btn');
            let modelChanged = false;

            if (addBtn && addBtn.closest('#d7-preventive-actions')) {
                window.app.data.d7.fields.preventiveActions.push({
                    action: '', type: 'Preventive', available: false, responsible: '', targetDate: '', status: 'Open', rpn: ''
                });
                modelChanged = true;
            }

            if (removeBtn) {
                if (confirm('Are you sure you want to remove this preventive action?')) {
                    const index = parseInt(removeBtn.dataset.index, 10);
                    window.app.data.d7.fields.preventiveActions.splice(index, 1);
                    modelChanged = true;
                }
            }

            if (modelChanged) {
                render();
                updateAppData();
            }
        });

        container.addEventListener('input', e => {
            if (e.target.closest('#d7-preventive-actions')) {
                updateAppData();
            }
        });

        container.dataset.d7ListenersAttached = 'true';

        document.addEventListener('appDataReady', render, { once: true });
        if (window.app && window.app.data) render();
    }

    const originalInit = window.__init8D;
    window.__init8D = function(context) {
        if(originalInit) originalInit(context);
        if(qs('#d7-preventive-actions', context)) {
            initializeD7Logic(context);
        }
    };

    if(qs('#d7-preventive-actions')) {
        initializeD7Logic(document);
    }
})();
</script>