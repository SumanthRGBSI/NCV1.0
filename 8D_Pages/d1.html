<!-- D1 — Identify Team -->
<div class="space-y-6">
  <datalist id="contact-directory"></datalist>

  <!-- Team Management Card -->
  <div class="ds-card">
    <div class="ds-card__header">
      <h3 class="ds-h3">Team Members</h3>
    </div>
    <div class="ds-card__body">
      <!-- Add Member Section -->
      <div class="flex flex-col sm:flex-row items-end gap-4 mb-6">
        <div class="flex-grow w-full">
          <label for="d1-person-search" class="ds-caption">Add by name or email</label>
          <input id="d1-person-search" class="ds-input" list="contact-directory" placeholder="Search directory and press Add…" />
        </div>
        <div class="flex items-center gap-2">
          <button id="d1-add-person" class="ds-btn ds-btn--primary">
            <i data-lucide="plus"></i>
            <span>Add</span>
          </button>
          <button id="d1-add-me" class="ds-btn ds-btn--secondary">Add Me</button>
        </div>
      </div>

      <!-- Team Table -->
      <div class="overflow-x-auto">
        <table id="d1-team-unified" class="ds-table ds-table--zebra ds-table--hover w-full">
          <thead>
            <tr>
              <th>Name</th>
              <th>Role</th>
              <th>Title</th>
              <th>Contact</th>
              <th class="w-12"></th>
            </tr>
          </thead>
          <tbody>
            <!-- Rows will be injected by JS -->
          </tbody>
          <tfoot>
            <tr>
              <td colspan="5">
                <button type="button" class="add-row-btn ds-btn ds-btn--tertiary w-full">
                  <i data-lucide="plus"></i>
                  <span>Add Member Manually</span>
                </button>
              </td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

  <!-- Visuals Card -->
  <div class="ds-card">
    <div class="ds-card__header">
      <h3 class="ds-h3">Visuals</h3>
    </div>
    <div class="ds-card__body grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <h4 class="font-bold text-slate-800">Team Cards</h4>
        <div id="d1-team-cards" class="team-cards-grid mt-4 space-y-2">
          <!-- Team cards will be injected by JS -->
        </div>
      </div>
      <div>
        <h4 class="font-bold text-slate-800">Team Org Chart</h4>
        <div id="d1-org-chart" class="mt-4 p-4 bg-slate-50 rounded-lg min-h-[150px]">
          <!-- Org chart will be injected by JS -->
        </div>
      </div>
    </div>
  </div>

  <!-- JS Template for Table Row -->
  <template id="d1-row-template">
    <tr>
      <td>
        <input class="ds-input contact-name" list="contact-directory" placeholder="Full name" />
      </td>
      <td class="member-role-group">
        <div class="flex items-center gap-x-4 gap-y-2 flex-wrap">
          <label class="flex items-center text-sm cursor-pointer">
            <input type="radio" name="member-role-placeholder" value="Team Member" class="ds-radio member-role">
            <span class="ml-1.5">Member</span>
          </label>
          <label class="flex items-center text-sm cursor-pointer">
            <input type="radio" name="member-role-placeholder" value="Team Lead" class="ds-radio member-role">
            <span class="ml-1.5">Lead</span>
          </label>
          <label class="flex items-center text-sm cursor-pointer">
            <input type="radio" name="member-role-placeholder" value="Champion" class="ds-radio member-role">
            <span class="ml-1.5">Champion</span>
          </label>
          <label class="flex items-center text-sm cursor-pointer">
            <input type="radio" name="member-role-placeholder" value="KPOC" class="ds-radio member-role">
            <span class="ml-1.5">KPOC</span>
          </label>
        </div>
      </td>
      <td>
        <input class="ds-input contact-title" placeholder="Job title" />
      </td>
      <td>
        <div class="flex flex-col gap-1">
          <input class="ds-input ds-input--compact contact-email" placeholder="Email" type="email" />
          <input class="ds-input ds-input--compact contact-phone" placeholder="Phone" type="tel" />
        </div>
      </td>
      <td>
        <button type="button" class="remove-row-btn ds-btn-icon ds-btn-icon--danger" aria-label="Remove">
          <i data-lucide="trash-2"></i>
        </button>
      </td>
    </tr>
  </template>
</div>

<!-- Scripts -->
<script>
  // This script is designed to be loaded dynamically and will not re-run on its own.
  // It attaches its logic to the global __init8D function.
  (function() {
    // Helper functions
    function qs(selector, context = document) { return context.querySelector(selector); }
    function qsa(selector, context = document) { return Array.from(context.querySelectorAll(selector)); }

    // This function will be called by the main app's __init8D
    function initializeD1Logic(context) {
        const tableBody = qs('#d1-team-unified tbody', context);
        if (!tableBody) return; // Exit if the D1 table isn't in the current context

        // --- Data Synchronization ---
        function updateAppData() {
            if (!window.app || !window.app.data || !window.app.data.d1) return;

            const members = qsa('tr', tableBody).map(tr => ({
                name: qs('.contact-name', tr)?.value || '',
                role: qs('.member-role:checked', tr)?.value || 'Team Member',
                title: qs('.contact-title', tr)?.value || '',
                email: qs('.contact-email', tr)?.value || '',
                phone: qs('.contact-phone', tr)?.value || ''
            }));

            window.app.data.d1.fields.members = members;
            window.app._dirty = true;
            if(window.app.updateSaveFab) window.app.updateSaveFab(true);
            if (window.app.saveData) {
                // Debounce saving
                clearTimeout(window.d1SaveTimer);
                window.d1SaveTimer = setTimeout(() => window.app.saveData('d1-team-update'), 600);
            }
            renderVisuals();
        }

        // --- Visuals Rendering ---
        function renderVisuals() {
            const members = (window.app && window.app.data && window.app.data.d1 && window.app.data.d1.fields.members) || [];
            const cardsContainer = qs('#d1-team-cards', context);
            const orgChartContainer = qs('#d1-org-chart', context);

            if (cardsContainer) {
                cardsContainer.innerHTML = ''; // Clear existing cards
                if (members.length > 0 && members.some(m => m.name)) {
                    members.forEach(member => {
                        if (!member.name) return; // Don't render empty cards
                        const cardHTML = `
                            <div class="p-3 bg-white rounded-lg border shadow-sm">
                                <p class="font-bold text-slate-800">${member.name}</p>
                                <p class="text-sm text-slate-600">${member.role || 'N/A'}</p>
                                <p class="text-xs text-slate-500 mt-1">${member.title || 'N/A'}</p>
                            </div>
                        `;
                        cardsContainer.insertAdjacentHTML('beforeend', cardHTML);
                    });
                } else {
                    cardsContainer.innerHTML = '<p class="ds-caption">No team members added yet.</p>';
                }
            }

            if (orgChartContainer) {
                orgChartContainer.innerHTML = ''; // Clear existing chart
                if (members.length > 0 && members.some(m => m.name)) {
                    const champion = members.find(m => m.role === 'Champion');
                    const lead = members.find(m => m.role === 'Team Lead' || m.role === 'KPOC');
                    const teamMembers = members.filter(m => m.role !== 'Champion' && m.role !== 'Team Lead' && m.role !== 'KPOC');

                    let chartHTML = '<ul class="space-y-2 text-sm">';
                    if (champion) {
                        chartHTML += `<li><strong>${champion.name}</strong> (Champion)</li>`;
                    }
                    if (lead) {
                        chartHTML += `<ul class="ml-4 space-y-1"><li><strong>${lead.name}</strong> (${lead.role})</li>`;
                        if (teamMembers.length > 0) {
                            chartHTML += '<ul class="ml-4 space-y-1 border-l pl-4">';
                            teamMembers.forEach(member => {
                                if (member.name) {
                                   chartHTML += `<li>${member.name} (Team Member)</li>`;
                                }
                            });
                            chartHTML += '</ul>';
                        }
                        chartHTML += '</ul>';
                    } else if (teamMembers.length > 0) {
                         chartHTML += '<ul class="ml-4 space-y-1 border-l pl-4">';
                         teamMembers.forEach(member => {
                            if (member.name) {
                                chartHTML += `<li>${member.name} (Team Member)</li>`;
                            }
                         });
                         chartHTML += '</ul>';
                    }
                    chartHTML += '</ul>';
                    orgChartContainer.innerHTML = chartHTML;

                } else {
                    orgChartContainer.innerHTML = '<p class="ds-caption text-center mt-4">Org chart will be generated here.</p>';
                }
            }
        }

        // --- DOM Manipulation ---
        function addRow(memberData = null, rowIndex) {
            const template = qs('#d1-row-template');
            if (!template) return;

            const newRow = template.content.firstElementChild.cloneNode(true);
            // Use the passed rowIndex to ensure a unique name for radio buttons
            const uniqueId = `member-role-${rowIndex}`;
            qsa('.member-role', newRow).forEach(radio => {
                radio.name = uniqueId;
            });

            if (memberData) {
                qs('.contact-name', newRow).value = memberData.name || '';
                qs('.contact-title', newRow).value = memberData.title || '';
                qs('.contact-email', newRow).value = memberData.email || '';
                qs('.contact-phone', newRow).value = memberData.phone || '';
                const role = memberData.role || 'Team Member';
                const radioToSelect = qs(`input.member-role[value="${role}"]`, newRow);
                if (radioToSelect) {
                    radioToSelect.checked = true;
                } else {
                    // Default to Team Member if role is not found
                    qs('input.member-role[value="Team Member"]', newRow).checked = true;
                }
            } else {
                 qs('input.member-role[value="Team Member"]', newRow).checked = true;
            }

            tableBody.appendChild(newRow);
        }

        function populateTableFromData() {
            if (!window.app || !window.app.data.d1) return;
            const members = window.app.data.d1.fields.members || [];
            tableBody.innerHTML = ''; // Clear before populating

            if (members.length > 0) {
                members.forEach((member, index) => addRow(member, index));
            } else {
                addRow(null, 0); // Start with one empty row
            }
        }

        // --- Event Listeners ---
        const container = tableBody.closest('.space-y-6');
        if (!container.dataset.d1ListenersAttached) {
            container.addEventListener('click', (e) => {
                const addManualBtn = e.target.closest('.add-row-btn');
                const addPersonBtn = e.target.closest('#d1-add-person');
                const addMeBtn = e.target.closest('#d1-add-me');
                const removeBtn = e.target.closest('.remove-row-btn');

                if (addManualBtn) {
                    e.stopImmediatePropagation(); // Stop the global handler
                    addRow(null, tableBody.children.length);
                    updateAppData();
                }
                if (addPersonBtn) {
                    const searchInput = qs('#d1-person-search');
                    if (searchInput && searchInput.value.trim()) {
                        addRow({ name: searchInput.value.trim() }, tableBody.children.length);
                        searchInput.value = '';
                        updateAppData();
                    }
                }
                if (addMeBtn) {
                    const currentUser = window.app && window.app.user ? window.app.user : { name: 'Current User', title: 'My Title', email: 'user@example.com' };
                    addRow(currentUser, tableBody.children.length);
                    updateAppData();
                }
                if (removeBtn) {
                    if (confirm('Are you sure you want to remove this team member?')) {
                        removeBtn.closest('tr').remove();
                        updateAppData();
                    }
                }
            });

            container.addEventListener('input', (e) => {
                if(e.target.matches('.contact-name, .member-role, .contact-title, .contact-email, .contact-phone')) {
                    updateAppData();
                }
            });
            container.dataset.d1ListenersAttached = 'true';
        }

        // --- Initial Population ---
        function render() {
            if (!window.app || !window.app.data || !window.app.data.d1) return;
            populateTableFromData();
            renderVisuals();
        }

        document.addEventListener('appDataReady', render, { once: true });
        if (window.app && window.app.data && window.app.data.d1) {
            render();
        }
    }

    // --- Hook into the global initializer ---
    const originalInit8D = window.__init8D;
    window.__init8D = function(context) {
        // Call the original initializer if it exists
        if (originalInit8D) {
            originalInit8D(context);
        }
        // If the D1 table is in the context, run our logic
        if (qs('#d1-team-unified', context)) {
            initializeD1Logic(context);
        }
    };

    // If this script loads after the page is already rendered, run the init logic.
    if(qs('#d1-team-unified')){
      initializeD1Logic(document);
    }
  })();
</script>