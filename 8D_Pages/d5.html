<!-- D5 â€” Select & Verify Corrective Actions -->
<div class="space-y-6">

  <!-- Corrective Actions Card -->
  <div class="ds-card">
    <div class="ds-card__header ds-card__header--sticky">
      <h3 class="ds-h3">5A. Selection & Verification of Corrective Actions</h3>
    </div>
    <div class="ds-card__body">
      <div class="overflow-x-auto">
        <table id="d5-actions" class="ds-table w-full">
          <thead class="text-sm">
            <tr>
              <th>Action</th>
              <th>Root Cause</th>
              <th>Target Date</th>
              <th>Responsibility</th>
              <th>Mistake Proof</th>
              <th>Status</th>
              <th>Risk</th>
              <th>History</th>
              <th class="w-12"></th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr><td colspan="9"><button class="add-row-btn ds-btn ds-btn--tertiary w-full"><i data-lucide="plus"></i> Add PCA</button></td></tr>
          </tfoot>
          <template>
            <tr>
              <td><textarea class="ds-textarea pca-action" placeholder="Describe the permanent corrective action..."></textarea></td>
              <td><select class="ds-select pca-root"><option value="">Select Root Cause</option></select></td>
              <td><input class="ds-input pca-target-date" type="date"/></td>
              <td><input class="ds-input pca-responsibility" placeholder="Owner"/></td>
              <td class="text-center">
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" class="sr-only peer mp-check">
                  <div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-500"></div>
                </label>
              </td>
              <td><select class="ds-select pca-status"><option>Pending</option><option>In Progress</option><option>Completed</option><option>Verified</option></select></td>
              <td><input class="ds-input pca-risk" type="number" placeholder="RPN"/></td>
              <td><button class="ds-btn ds-btn--secondary ds-btn--sm w-full"><i data-lucide="history"></i> View</button></td>
              <td><button class="remove-row-btn ds-btn-icon ds-btn-icon--danger"><i data-lucide="trash-2"></i></button></td>
            </tr>
          </template>
        </table>
      </div>
    </div>
    <div class="ds-card__body border-t border-slate-200 space-y-4">
        <div>
            <label class="ds-caption" for="d5-docs">5B. Corrective Action Images / Documents</label>
            <input id="d5-docs" class="ds-input preview-file mt-1" type="file" multiple />
            <div class="file-preview mt-2"></div>
        </div>
        <div>
            <label class="ds-caption" for="d5-selectedPCA">5C. Summary of Selected Permanent Corrective Action(s)</label>
            <textarea id="d5-selectedPCA" class="ds-textarea" placeholder="Summarize the key actions chosen..."></textarea>
            <div class="text-xs text-slate-500 text-right" id="d5-pca-counter">0 characters</div>
        </div>
    </div>
  </div>

  <!-- Timeline & Checklist Card -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="ds-card">
      <div class="ds-card__header">
        <h3 class="ds-h3">Implementation Timeline (Gantt)</h3>
      </div>
      <div class="ds-card__body">
        <div id="d5-gantt" class="p-2 bg-slate-50 rounded-lg min-h-[200px]">
          <!-- Gantt chart will be rendered here by JS -->
        </div>
      </div>
    </div>

    <div class="ds-card">
      <div class="ds-card__header">
        <h3 class="ds-h3">Verification Checklist</h3>
      </div>
      <div class="ds-card__body">
        <div class="flex items-center gap-2 mb-4">
          <input id="d5-new-check" class="ds-input flex-grow" placeholder="Add checklist item..." />
          <button id="d5-add-check" class="ds-btn ds-btn--primary"><i data-lucide="plus"></i> Add</button>
        </div>
        <div id="d5-checklist" class="space-y-2">
          <!-- Checklist items will be injected here by JS -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.css">
<script>
  (function() {
    if (window.d5Initialized) return;
    window.d5Initialized = true;

    function qs(selector, context = document) { return context.querySelector(selector); }

    function initializeD5Logic(context) {
        const actionsTable = qs('#d5-actions', context);
        const checklistContainer = qs('#d5-checklist', context);

        if (!actionsTable || !checklistContainer) return;

        const actionsTbody = actionsTable.querySelector('tbody');
        const actionsTemplate = actionsTable.querySelector('template');

        function render() {
            if (!window.app || !window.app.data || !window.app.data.d5) return;

            const actions = window.app.data.d5.fields.correctiveActions || [];
            const rootCauses = (window.app.data.d4?.fields?.fiveWhys || []).map(item => item.because);
            actionsTbody.innerHTML = '';

            actions.forEach(action => {
                const newRow = actionsTemplate.content.cloneNode(true);
                qs('.pca-action', newRow).value = action.action || '';
                qs('.pca-target-date', newRow).value = action.targetDate || '';
                qs('.pca-responsibility', newRow).value = action.responsibility || '';
                qs('.mp-check', newRow).checked = !!action.mistakeProof;
                qs('.pca-status', newRow).value = action.status || 'Pending';
                qs('.pca-risk', newRow).value = action.risk || '';

                const rootCauseSelect = qs('.pca-root', newRow);
                rootCauses.forEach(rc => {
                    const option = document.createElement('option');
                    option.value = rc;
                    option.textContent = rc;
                    rootCauseSelect.appendChild(option);
                });
                rootCauseSelect.value = action.rootCause || '';
                actionsTbody.appendChild(newRow);
            });

            const checklist = window.app.data.d5.fields.verificationChecklist || [];
            checklistContainer.innerHTML = '';
            checklist.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between ds-checkbox';
                div.innerHTML = `
                    <label for="d5-check-${index}" class="flex items-center gap-2">
                        <input type="checkbox" id="d5-check-${index}" data-index="${index}" ${item.done ? 'checked' : ''}>
                        <span>${item.item}</span>
                    </label>
                    <button class="ds-btn-icon ds-btn-icon--danger remove-check-btn" data-index="${index}"><i data-lucide="trash-2"></i></button>
                `;
                checklistContainer.appendChild(div);
            });
            if(window.lucide) window.lucide.createIcons();
        }

        // Listen for the appDataReady event
        document.addEventListener('appDataReady', render, { once: true });
        // If data is already available, render immediately
        if (window.app && window.app.data) {
            render();
        }
    }

    const originalInit = window.__init8D;
    window.__init8D = function(context) {
        if (originalInit) originalInit(context);
        if (qs('#d5-actions', context)) {
            initializeD5Logic(context);
        }
    };

    if (qs('#d5-actions')) {
        initializeD5Logic(document);
    }
  })();
</script>