<!-- D2 â€” Problem Description -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

  <!-- Left Column -->
  <div class="lg:col-span-2 space-y-6">
    <!-- Problem Definition Card -->
    <div class="ds-card">
      <div class="ds-card__header">
        <h3 class="ds-h3">Problem Definition</h3>
      </div>
      <div class="ds-card__body space-y-4">
        <div>
          <label class="ds-caption" for="d2-problemStatement">2A. Problem Description</label>
          <textarea id="d2-problemStatement" class="ds-textarea h-32" placeholder="Provide a detailed description of the problem..."></textarea>
        </div>
        <div>
          <div class="flex justify-between items-center">
            <label class="ds-caption" for="d2-briefStatement" data-required>2B. Problem Statement (One-sentence summary)</label>
            <button id="d2-generate-statement" class="ds-btn ds-btn--sm ds-btn--secondary">
              <i data-lucide="sparkles" class="w-3 h-3"></i>
              <span>Generate</span>
            </button>
          </div>
          <input id="d2-briefStatement" class="ds-input mt-1" placeholder="e.g., The mounting bracket fails under normal load." data-required />
        </div>

        <!-- 5W2H Section -->
        <div class="space-y-4 pt-2">
          <h4 class="font-semibold text-slate-700">2C. 5W2H Analysis</h4>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
            <div class="sm:col-span-2">
              <label class="ds-caption" for="d2-what">What Happened? (Problem description)</label>
              <input id="d2-what" class="ds-input" placeholder="e.g., The mounting bracket fails under normal load."/>
            </div>
            <div>
              <label class="ds-caption" for="d2-when">When Detected? (Timeline/date of discovery)</label>
              <input id="d2-when" class="ds-input" placeholder="e.g., During assembly, after 3 months of use..." />
            </div>
            <div>
              <label class="ds-caption" for="d2-where">Where Detected? (Location/process stage)</label>
              <input id="d2-where" class="ds-input" placeholder="e.g., On the vehicle, at the customer plant..." />
            </div>
            <div>
              <label class="ds-caption" for="d2-who">Who Detected? (Person/team who identified the issue)</label>
              <input id="d2-who" class="ds-input" placeholder="e.g., QA Team C, Operator 5"/>
            </div>
            <div>
              <label class="ds-caption" for="d2-how">How Detected? (Detection method/mechanism)</label>
              <input id="d2-how" class="ds-input" placeholder="e.g., Visual inspection, customer report"/>
            </div>
            <div class="sm:col-span-2">
                <label class="ds-caption" for="d2-why">Why is this a problem? (Impact)</label>
                <input id="d2-why" class="ds-input" placeholder="e.g., It violates regulation X, it prevents function Y..." />
            </div>
            <div class="sm:col-span-2">
              <label class="ds-caption" for="d2-howMany">How Many? (Scope/quantity affected)</label>
              <input id="d2-howMany" class="ds-input" type="number" placeholder="e.g., 1500"/>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Process Audit Card -->
    <div class="ds-card">
      <div class="ds-card__header">
        <h3 class="ds-h3">2E. Process Audit</h3>
        <p class="ds-caption mt-1">Identify all process steps and check for potential causes of the problem.</p>
      </div>
      <div class="ds-card__body overflow-x-auto">
        <table class="ds-table w-full" id="d2-process-audit">
            <thead><tr><th>Process Step</th><th>Potential Root Cause</th><th>Action (Y/N)</th><th class="w-12"></th></tr></thead>
            <tbody></tbody>
            <tfoot><tr><td colspan="4"><button type="button" class="add-row-btn ds-btn ds-btn--tertiary w-full"><i data-lucide="plus"></i> Add Row</button></td></tr></tfoot>
            <template>
                <tr>
                    <td><input class="ds-input audit-step" placeholder="Step (e.g., Assembly)" /></td>
                    <td><input class="ds-input audit-cause" placeholder="Possible cause" /></td>
                    <td><select class="ds-select audit-action"><option>Yes</option><option>No</option></select></td>
                    <td><button type="button" class="remove-row-btn ds-btn-icon ds-btn-icon--danger"><i data-lucide="trash-2"></i></button></td>
                </tr>
            </template>
        </table>
      </div>
    </div>

    <!-- Control Documentary Card -->
    <div class="ds-card">
      <div class="ds-card__header">
        <h3 class="ds-h3">2F. Control Documentary</h3>
        <p class="ds-caption mt-1">Review all relevant control documents for completeness and accuracy.</p>
      </div>
      <div class="ds-card__body overflow-x-auto">
        <table class="ds-table w-full" id="d2-docs">
            <thead><tr><th>Document</th><th>Reviewed (Y/N)</th><th>Current RPN</th><th class="w-12"></th></tr></thead>
            <tbody></tbody>
            <tfoot><tr><td colspan="4"><button type="button" class="add-row-btn ds-btn ds-btn--tertiary w-full"><i data-lucide="plus"></i> Add Document</button></td></tr></tfoot>
            <template>
                <tr>
                    <td><input class="ds-input doc-name" placeholder="Document name (PFMEA, Control Plan)" /></td>
                    <td><select class="ds-select doc-reviewed"><option>Yes</option><option>No</option></select></td>
                    <td><input class="ds-input doc-rpn" placeholder="Current RPN" type="number" /></td>
                    <td><button type="button" class="remove-row-btn ds-btn-icon ds-btn-icon--danger"><i data-lucide="trash-2"></i></button></td>
                </tr>
            </template>
        </table>
      </div>
    </div>
  </div>

  <!-- Right Column -->
  <div class="lg:col-span-1 space-y-6">
    <!-- Part Information Card -->
    <div class="ds-card">
      <div class="ds-card__header">
        <h3 class="ds-h3">Part Information</h3>
      </div>
      <div class="ds-card__body">
        <label for="d2-partSearch" class="ds-caption">Search by part name or number</label>
        <input id="d2-partSearch" class="ds-input" placeholder="Search..." />
        <div id="d2-partCard" class="mt-4 text-sm text-slate-500"></div>
      </div>
    </div>

    <!-- File Upload Card -->
    <div class="ds-card">
      <div class="ds-card__header">
        <h3 class="ds-h3">Evidence</h3>
      </div>
      <div class="ds-card__body">
        <label for="d2-evidence" class="ds-caption">Upload images or documents</label>
        <div class="mt-1">
          <input class="ds-input preview-file" type="file" id="d2-evidence" />
          <div class="file-preview mt-2"></div>
        </div>
        <div class="mt-2">
            <button class="ds-btn ds-btn--secondary annotate-btn" data-for="#d2-evidence"><i data-lucide="edit-3"></i> Annotate</button>
        </div>
      </div>
    </div>

    <!-- Before State Card -->
    <div class="ds-card">
        <div class="ds-card__header">
            <h3 class="ds-h3">Baseline State</h3>
        </div>
        <div class="ds-card__body space-y-4">
            <div>
                <label class="ds-caption" for="d2-situationBefore">2G. Situation Before Countermeasures</label>
                <textarea id="d2-situationBefore" class="ds-textarea" placeholder="Describe the baseline state before countermeasures..."></textarea>
            </div>
            <div>
                <label class="ds-caption" for="d2-before-files">2H. Graphs & Images (Before)</label>
                <input class="ds-input preview-file" type="file" id="d2-before-files" multiple />
                <div class="file-preview mt-2"></div>
            </div>
        </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script>
(function() {
    if (window.d2Initialized) return;
    window.d2Initialized = true;

    function qs(selector, context = document) { return context.querySelector(selector); }

    function initializeD2Logic(context) {
        // --- Part Card Logic ---
        function renderPartCard(part) {
            const host = qs('#d2-partCard', context);
            if (!host) return;
            host.innerHTML = !part ? '<div class="text-slate-500 text-sm">No part selected.</div>' : `
                <table class="ds-table w-full text-sm"><tbody>
                    <tr><td class="font-semibold text-slate-600 w-1/3">Name</td><td>${part.name || '-'}</td></tr>
                    <tr><td class="font-semibold text-slate-600">Number</td><td>${part.number || '-'}</td></tr>
                    <tr><td class="font-semibold text-slate-600">Supplier</td><td>${part.supplier || '-'}</td></tr>
                    <tr><td class="font-semibold text-slate-600">Revision</td><td>${part.revision || '-'}</td></tr>
                </tbody></table>`;
        }

        async function lookupPart(query) {
            try {
                if (window.DataStore) {
                    const index = await window.DataStore.get('parts-index');
                    return Array.isArray(index) ? index.find(p => (p.name || '').toLowerCase().includes(query) || (p.number || '').toLowerCase().includes(query)) || null : null;
                }
            } catch (err) { console.error("Part lookup failed:", err); }
            return null;
        }

        const searchInput = qs('#d2-partSearch', context);
        if (searchInput && !searchInput.dataset.listenerAttached) {
            searchInput.addEventListener('change', async () => {
                const query = (searchInput.value || '').toLowerCase().trim();
                renderPartCard(query ? await lookupPart(query) : null);
            });
            searchInput.dataset.listenerAttached = 'true';
        }
        renderPartCard(null);

        // --- Statement Generation ---
        const generateBtn = qs('#d2-generate-statement', context);
        if (generateBtn && !generateBtn.dataset.listenerAttached) {
            generateBtn.addEventListener('click', () => {
                const problemDesc = qs('#d2-problemStatement', context);
                const briefStatement = qs('#d2-briefStatement', context);
                const fullText = problemDesc.value.trim();
                if (!fullText) {
                    problemDesc.focus();
                    return;
                }
                const firstSentence = fullText.split(/[.!?]/)[0].trim();
                if (firstSentence) {
                    briefStatement.value = firstSentence + '.';
                    briefStatement.dispatchEvent(new Event('input', { bubbles: true }));
                }
            });
            generateBtn.dataset.listenerAttached = 'true';
        }

        // --- Table Rendering Logic ---
        function renderTables() {
            if (!window.app || !window.app.data || !window.app.data.d2) return;

            const auditTbody = qs('#d2-process-audit tbody', context);
            const auditData = window.app.data.d2.fields.processAudit || [];
            const auditTemplate = qs('#d2-process-audit template', context);
            if (auditTbody && auditTemplate) {
                auditTbody.innerHTML = '';
                auditData.forEach(item => {
                    const newRow = auditTemplate.content.cloneNode(true);
                    qs('.audit-step', newRow).value = item.step || '';
                    qs('.audit-cause', newRow).value = item.cause || '';
                    qs('.audit-action', newRow).value = item.action || 'No';
                    auditTbody.appendChild(newRow);
                });
            }

            const docsTbody = qs('#d2-docs tbody', context);
            const docsData = window.app.data.d2.fields.controlDocs || [];
            const docsTemplate = qs('#d2-docs template', context);
            if (docsTbody && docsTemplate) {
                docsTbody.innerHTML = '';
                docsData.forEach(item => {
                    const newRow = docsTemplate.content.cloneNode(true);
                    qs('.doc-name', newRow).value = item.document || '';
                    qs('.doc-reviewed', newRow).value = item.reviewed || 'No';
                    qs('.doc-rpn', newRow).value = item.rpn || '';
                    docsTbody.appendChild(newRow);
                });
            }
            if (window.lucide) window.lucide.createIcons();
        }

        document.addEventListener('appDataReady', renderTables, { once: true });
        if (window.app && window.app.data && window.app.data.d2) {
            renderTables();
        }
    }

    const originalInit = window.__init8D;
    window.__init8D = function(context) {
        if (originalInit) originalInit(context);
        if (qs('#d2-problemStatement', context)) {
            initializeD2Logic(context);
        }
    };

    if (qs('#d2-problemStatement')) {
        initializeD2Logic(document);
    }
})();
</script>