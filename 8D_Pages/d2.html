<!-- D2 â€” Problem Description -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

  <!-- Left Column -->
  <div class="lg:col-span-2 space-y-6">
    <!-- Problem Definition Card -->
    <div class="ds-card">
      <div class="ds-card__header">
        <h3 class="ds-h3">Problem Definition</h3>
      </div>
      <div class="ds-card__body space-y-4">
        <div>
          <label class="ds-caption" for="d2-problemStatement">2A. Problem Description</label>
          <textarea id="d2-problemStatement" class="ds-textarea h-32" placeholder="Provide a detailed description of the problem..."></textarea>
        </div>
        <div>
          <div class="flex justify-between items-center">
            <label class="ds-caption" for="d2-briefStatement" data-required>2B. Problem Statement (One-sentence summary)</label>
            <button id="d2-generate-statement" class="ds-btn ds-btn--sm ds-btn--secondary">
              <i data-lucide="sparkles" class="w-3 h-3"></i>
              <span>Generate</span>
            </button>
          </div>
          <input id="d2-briefStatement" class="ds-input mt-1" placeholder="e.g., The mounting bracket fails under normal load." data-required />
        </div>

        <!-- 5W2H Section -->
        <div class="space-y-4 pt-2">
          <h4 class="font-semibold text-slate-700">2C. 5W2H Analysis</h4>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
            <div class="sm:col-span-2">
              <label class="ds-caption" for="d2-what">What Happened? (Problem description)</label>
              <input id="d2-what" class="ds-input" placeholder="e.g., The mounting bracket fails under normal load."/>
            </div>
            <div>
              <label class="ds-caption" for="d2-when">When Detected? (Timeline/date of discovery)</label>
              <input id="d2-when" class="ds-input" placeholder="e.g., During assembly, after 3 months of use..." />
            </div>
            <div>
              <label class="ds-caption" for="d2-where">Where Detected? (Location/process stage)</label>
              <input id="d2-where" class="ds-input" placeholder="e.g., On the vehicle, at the customer plant..." />
            </div>
            <div>
              <label class="ds-caption" for="d2-who">Who Detected? (Person/team who identified the issue)</label>
              <input id="d2-who" class="ds-input" placeholder="e.g., QA Team C, Operator 5"/>
            </div>
            <div>
              <label class="ds-caption" for="d2-how">How Detected? (Detection method/mechanism)</label>
              <input id="d2-how" class="ds-input" placeholder="e.g., Visual inspection, customer report"/>
            </div>
            <div class="sm:col-span-2">
                <label class="ds-caption" for="d2-why">Why is this a problem? (Impact)</label>
                <input id="d2-why" class="ds-input" placeholder="e.g., It violates regulation X, it prevents function Y..." />
            </div>
            <div class="sm:col-span-2">
              <label class="ds-caption" for="d2-howMany">How Many? (Scope/quantity affected)</label>
              <input id="d2-howMany" class="ds-input" type="number" placeholder="e.g., 1500"/>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Process Audit Card -->
    <div class="ds-card">
      <div class="ds-card__header">
        <h3 class="ds-h3">2E. Process Audit</h3>
        <p class="ds-caption mt-1">Identify all process steps and check for potential causes of the problem.</p>
      </div>
      <div class="ds-card__body overflow-x-auto">
        <table class="ds-table w-full" id="d2-process-audit">
            <thead><tr><th>Process Step</th><th>Potential Root Cause</th><th>Action (Y/N)</th><th class="w-12"></th></tr></thead>
            <tbody></tbody>
            <tfoot><tr><td colspan="4"><button type="button" class="add-row-btn ds-btn ds-btn--tertiary w-full"><i data-lucide="plus"></i> Add Row</button></td></tr></tfoot>
            <template>
                <tr>
                    <td><input class="ds-input" placeholder="Step (e.g., Assembly)" /></td>
                    <td><input class="ds-input" placeholder="Possible cause" /></td>
                    <td><select class="ds-select"><option>Yes</option><option>No</option></select></td>
                    <td><button type="button" class="remove-row-btn ds-btn-icon ds-btn-icon--danger"><i data-lucide="trash-2"></i></button></td>
                </tr>
            </template>
        </table>
      </div>
    </div>

    <!-- Control Documentary Card -->
    <div class="ds-card">
      <div class="ds-card__header">
        <h3 class="ds-h3">2F. Control Documentary</h3>
        <p class="ds-caption mt-1">Review all relevant control documents for completeness and accuracy.</p>
      </div>
      <div class="ds-card__body overflow-x-auto">
        <table class="ds-table w-full" id="d2-docs">
            <thead><tr><th>Document</th><th>Reviewed (Y/N)</th><th>Current RPN</th><th class="w-12"></th></tr></thead>
            <tbody></tbody>
            <tfoot><tr><td colspan="4"><button type="button" class="add-row-btn ds-btn ds-btn--tertiary w-full"><i data-lucide="plus"></i> Add Document</button></td></tr></tfoot>
            <template>
                <tr>
                    <td><input class="ds-input" placeholder="Document name (PFMEA, Control Plan)" /></td>
                    <td><select class="ds-select"><option>Yes</option><option>No</option></select></td>
                    <td><input class="ds-input" placeholder="Current RPN" type="number" /></td>
                    <td><button type="button" class="remove-row-btn ds-btn-icon ds-btn-icon--danger"><i data-lucide="trash-2"></i></button></td>
                </tr>
            </template>
        </table>
      </div>
    </div>
  </div>

  <!-- Right Column -->
  <div class="lg:col-span-1 space-y-6">
    <!-- Part Information Card -->
    <div class="ds-card">
      <div class="ds-card__header">
        <h3 class="ds-h3">Part Information</h3>
      </div>
      <div class="ds-card__body">
        <label for="d2-partSearch" class="ds-caption">Search by part name or number</label>
        <input id="d2-partSearch" class="ds-input" placeholder="Search..." />
        <div id="d2-partCard" class="mt-4 text-sm text-slate-500"></div>
      </div>
    </div>

    <!-- File Upload Card -->
    <div class="ds-card">
      <div class="ds-card__header">
        <h3 class="ds-h3">Evidence</h3>
      </div>
      <div class="ds-card__body">
        <label for="d2-evidence" class="ds-caption">Upload images or documents</label>
        <div class="mt-1">
          <input class="ds-input preview-file" type="file" id="d2-evidence" />
          <div class="file-preview mt-2"></div>
        </div>
        <div class="mt-2">
            <button class="ds-btn ds-btn--secondary annotate-btn" data-for="#d2-evidence"><i data-lucide="edit-3"></i> Annotate</button>
        </div>
      </div>
    </div>

    <!-- Before State Card -->
    <div class="ds-card">
        <div class="ds-card__header">
            <h3 class="ds-h3">Baseline State</h3>
        </div>
        <div class="ds-card__body space-y-4">
            <div>
                <label class="ds-caption" for="d2-situationBefore">2G. Situation Before Countermeasures</label>
                <textarea id="d2-situationBefore" class="ds-textarea" placeholder="Describe the baseline state before countermeasures..."></textarea>
            </div>
            <div>
                <label class="ds-caption" for="d2-before-files">2H. Graphs & Images (Before)</label>
                <input class="ds-input preview-file" type="file" id="d2-before-files" multiple />
                <div class="file-preview mt-2"></div>
            </div>
        </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script>
  // Ensure the main app initialization logic runs
  if (window.__init8D) {
    window.__init8D(document);
  }

  (function(){
    function qs(selector, context = document) { return context.querySelector(selector); }

    // Renders the part card with new DS styles
    function renderPartCard(part) {
      const host = qs('#d2-partCard');
      if (!host) return;
      if (!part) {
        host.innerHTML = '<div class="text-slate-500 text-sm">No part selected.</div>';
        return;
      }
      host.innerHTML = `
        <table class="ds-table w-full text-sm">
          <tbody>
            <tr><td class="font-semibold text-slate-600 w-1/3">Name</td><td>${part.name || '-'}</td></tr>
            <tr><td class="font-semibold text-slate-600">Number</td><td>${part.number || '-'}</td></tr>
            <tr><td class="font-semibold text-slate-600">Supplier</td><td>${part.supplier || '-'}</td></tr>
            <tr><td class="font-semibold text-slate-600">Revision</td><td>${part.revision || '-'}</td></tr>
          </tbody>
        </table>`;
    }

    // Async function to look up part data
    async function lookupPart(query) {
      try {
        if (window.DataStore) {
          const index = await window.DataStore.get('parts-index');
          if (Array.isArray(index)) {
            const found = index.find(p =>
              (p.name || '').toLowerCase().includes(query) ||
              (p.number || '').toLowerCase().includes(query)
            );
            return found || null;
          }
        }
      } catch (err) {
        console.error("Part lookup failed:", err);
      }
      return null;
    }

    // Attach event listener to the part search input
    const searchInput = qs('#d2-partSearch');
    if (searchInput) {
      searchInput.addEventListener('change', async () => {
        const query = (searchInput.value || '').toLowerCase().trim();
        const part = query ? await lookupPart(query) : null;
        renderPartCard(part);
      });
    }

    // Initial render
    renderPartCard(null);

    // --- Automated Problem Statement Generation ---
    const generateBtn = qs('#d2-generate-statement');
    const problemDesc = qs('#d2-problemStatement');
    const briefStatement = qs('#d2-briefStatement');

    if (generateBtn && problemDesc && briefStatement) {
      generateBtn.addEventListener('click', () => {
        const fullText = problemDesc.value.trim();
        if (!fullText) {
          problemDesc.focus();
          problemDesc.placeholder = 'Please provide a description first.';
          return;
        }
        // A simple way to get the first sentence.
        const firstSentence = fullText.split(/[.!?]/)[0].trim();
        if (firstSentence) {
          briefStatement.value = firstSentence + '.';
          // Trigger an input event so any data binding or autosave logic fires
          briefStatement.dispatchEvent(new Event('input', { bubbles: true }));
        }
      });
    }

    // --- File Preview Thumbnail Generation ---
    document.addEventListener('change', function(event) {
      if (!event.target.matches('.preview-file')) return;

      const input = event.target;
      const previewContainer = input.nextElementSibling;

      if (!previewContainer || !previewContainer.matches('.file-preview')) {
        console.warn('No .file-preview element found after the input.');
        return;
      }

      previewContainer.innerHTML = ''; // Clear previous previews

      if (input.files && input.files.length > 0) {
        const files = Array.from(input.files);
        files.forEach(file => {
          const previewWrapper = document.createElement('div');
          previewWrapper.className = 'p-2 border rounded-md bg-slate-50 text-sm flex items-center gap-2 mt-1';

          if (file.type.startsWith('image/')) {
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            img.className = 'w-12 h-12 object-cover rounded';
            img.onload = () => URL.revokeObjectURL(img.src); // Free up memory
            previewWrapper.appendChild(img);
          } else {
            const icon = document.createElement('i');
            icon.dataset.lucide = 'file-text';
            icon.className = 'w-8 h-8 text-slate-500';
            previewWrapper.appendChild(icon);
          }

          const textContainer = document.createElement('div');
          const fileName = document.createElement('p');
          fileName.className = 'font-semibold text-slate-700';
          fileName.textContent = file.name;

          const fileSize = document.createElement('p');
          fileSize.className = 'text-xs text-slate-500';
          fileSize.textContent = `${(file.size / 1024).toFixed(1)} KB`;

          textContainer.appendChild(fileName);
          textContainer.appendChild(fileSize);
          previewWrapper.appendChild(textContainer);
          previewContainer.appendChild(previewWrapper);
        });

        // Re-initialize icons if a library like Lucide is used dynamically
        if (window.lucide) {
            window.lucide.createIcons();
        }
      }
    });

  })();
</script>