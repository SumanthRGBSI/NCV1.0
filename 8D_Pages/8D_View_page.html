<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8D Problem-Solving Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../assets/design-system.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --status-pending-bg: #e5e7eb;
            --status-pending-text: #4b5563;
            --status-in-progress-bg: #f59e0b;
            --status-in-progress-text: #ffffff;
            --status-completed-bg: #10b981;
            --status-completed-text: #ffffff;
            --active-bg: #eff6ff;
            --active-border: #3b82f6;
        }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
        #stepper-nav { position: relative; }
        .step { position: relative; z-index: 10; }
        #stepper-nav::before { content: ''; position: absolute; left: 1.25rem; top: 1.25rem; bottom: 1.25rem; width: 2px; background-color: #e5e7eb; z-index: 1; transition: left 0.3s ease-in-out; }
        .step-circle { width: 2.5rem; height: 2.5rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; font-weight: 700; transition: all 0.3s; background-color: var(--status-pending-bg); color: var(--status-pending-text); position: relative; }
        .step-link.status-in-progress .step-circle { background-color: var(--status-in-progress-bg); color: var(--status-in-progress-text); }
        .step-link.status-completed .step-circle { background-color: var(--status-completed-bg); color: var(--status-completed-text); }
        .step-link.active .step-content { background-color: var(--active-bg); border-color: var(--active-border); color: var(--active-border); }
        .step-link.active .step-arrow { opacity: 1; }
        .step-content { transition: border 0.3s, background-color 0.3s, color 0.3s; border: 1px solid transparent; }
        .step-arrow { opacity: 0; transition: opacity 0.3s; color: var(--active-border); }
        #content-container.loading { opacity: 0.5; transition: opacity 0.3s; }
        #overall-progress-wrap{ height:6px;background:#e5e7eb;border-radius:9999px;overflow:hidden;margin-top:2px; }
        #overall-progress-bar{ height:100%;width:0%;background:#10b981;transition:width .3s ease; }
        #sidebar { transition: width 0.3s ease-in-out, padding 0.3s ease-in-out, background-color 0.3s ease-in-out; }
        main#main-panel { transition: width 0.3s ease-in-out, flex 0.3s ease-in-out; }
        #app-container.sidebar-collapsed #sidebar { width: 6rem; padding-left: 0.75rem; padding-right: 0.75rem; }
        #app-container.sidebar-collapsed .sidebar-text, #app-container.sidebar-collapsed .step-content { display: none; }
        #app-container.sidebar-collapsed #stepper-nav::before { left: 1.25rem; }
        #app-container.sidebar-collapsed .step { justify-content: center; }
        #app-container.sidebar-collapsed #toggle-btn-icon { transform: rotate(180deg); }
        #app-container #main-panel { flex: 1 1 auto; width: auto; max-width: none; }
        .step-link{ position: relative; }

        /* Default tooltip style */
        .step-link[data-tooltip]:hover::after, .step-link[data-tooltip]:hover::before { display: none; }

        /* Show tooltip only when sidebar is collapsed */
        #app-container.sidebar-collapsed .step-link[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            display: block;
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            margin-left: 12px; /* Add some space from the icon */
            background: #1f2937;
            color: #fff;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 18px rgba(0,0,0,0.2);
            width: 18rem; /* Give it enough width */
            font-size: 0.875rem;
            line-height: 1.4;
            z-index: 50;
            pointer-events: none; /* Prevent tooltip from interfering with mouse */
        }

        #app-container.sidebar-collapsed .step-link[data-tooltip]:hover::before {
            content: '';
            display: block;
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            margin-left: 6px;
            border-width: 6px;
            border-style: solid;
            border-color: transparent #1f2937 transparent transparent;
            z-index: 51;
            pointer-events: none;
        }
        #stepper-nav { position: relative; }
        #stepper-progress { position: absolute; left: 1.25rem; top: 1.25rem; width: 2px; height: 0; background-color: #10b981; z-index: 2; transition: height 0.4s ease; }
        .step-abbr{ display:inline; }
        .step-icon-circle{ display:none; }
        /* No special behavior needed for collapsed view; abbreviation will remain visible. */
        a:focus-visible, button:focus-visible, select:focus-visible, input:focus-visible, textarea:focus-visible { outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,0.45); border-color: #93c5fd; }
        .skeleton{ position:relative; overflow:hidden; background:#f3f4f6; }
        .skeleton::after{ content:''; position:absolute; inset:0; background: linear-gradient(90deg, rgba(243,244,246,0) 0%, rgba(209,213,219,.7) 50%, rgba(243,244,246,0) 100%); transform:translateX(-100%); animation: sk 1.2s infinite; }
        @keyframes sk{ to { transform: translateX(100%); } }
        /* Context bar */
        #context-bar { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; padding: 0.5rem; background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 6px 18px rgba(2,6,23,0.06); }
        /* Floating save bar */
        #save-fab { position: fixed; left: 50%; transform: translateX(-50%); bottom: 16px; background: #0f172a; color: #fff; padding: 8px 10px; border-radius: 9999px; box-shadow: 0 12px 28px rgba(0,0,0,0.22); display: none; align-items: center; gap: 8px; z-index: 60; }
        #save-fab.visible { display: inline-flex; }
        /* Sticky section headers inside content */
        .sticky-section-title { position: sticky; top: 8px; background: #fff; z-index: 5; padding-top: 4px; }
    </style>
</head>
<body class="antialiased">
    <div id="app-container" class="flex h-screen bg-gray-100">
        <nav id="sidebar" class="w-1/3 lg:w-1/4 bg-white p-6 shadow-lg flex flex-col transition-all duration-300">
            <div class="flex items-center mb-2">
                <div class="bg-blue-600 p-2 rounded-lg">
                    <i data-lucide="sitemap" class="text-white fa-lg"></i>
                </div>
                <div class="ml-3 sidebar-text">
                    <h1 class="text-xl font-bold text-gray-800">8D Process</h1>
                    <p class="text-sm text-gray-500">Problem Solving Framework</p>
                </div>
            </div>
            <div class="border-t my-6"></div>
            <div id="stepper-nav" class="stepper flex-grow overflow-y-auto pr-2"></div>
            <div class="mt-auto pt-6 border-t">
                <div class="flex items-center justify-between sidebar-text mb-2">
                    <button id="expand-all-btn" class="ds-btn ds-btn--sm ds-btn--tertiary text-xs">Expand All</button>
                    <button id="collapse-all-btn" class="ds-btn ds-btn--sm ds-btn--tertiary text-xs">Collapse All</button>
                </div>
                <button id="sidebar-toggle-btn" class="w-full flex items-center p-3 rounded-lg text-gray-600 hover:bg-gray-100 transition-colors">
                    <i id="toggle-btn-icon" data-lucide="chevron-left" class="transition-transform duration-300"></i>
                    <span class="ml-4 font-semibold sidebar-text">Collapse</span>
                </button>
            </div>
        </nav>
        <main id="main-panel" class="w-2/3 lg:w-3/4 p-4 md:p-8 overflow-y-auto">
            <nav id="breadcrumb" class="mb-3 text-sm font-medium text-gray-500" aria-label="Breadcrumb"></nav>
            <div id="content-toolbar" class="flex items-center justify-between mb-3">
              <div class="flex flex-col">
                <div class="text-xs text-gray-600" id="progress-summary"></div>
                <div id="overall-progress-wrap"><div id="overall-progress-bar"></div></div>
              </div>
              <div class="flex items-center gap-2">
                <div class="relative" id="export-dropdown">
                  <button id="export-toggle" class="px-3 py-2 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 text-sm font-semibold focus-ring"><i data-lucide="download" class="mr-1"></i> Export</button>
                  <div id="export-menu" class="hidden absolute right-0 mt-2 w-44 bg-white border border-gray-200 rounded-lg shadow-lg z-20">
                    <a href="#" id="export-csv" class="block px-3 py-2 text-sm text-gray-700 hover:bg-gray-50">Export CSV</a>
                    <a href="#" id="export-json" class="block px-3 py-2 text-sm text-gray-700 hover:bg-gray-50">Export JSON</a>
                    <a href="#" id="print-pdf" class="block px-3 py-2 text-sm text-gray-700 hover:bg-gray-50">Print / PDF</a>
                  </div>
                </div>
              </div>
            </div>
            <div id="context-bar" class="mb-4"></div>
            <div id="content-container"></div>
        </main>
    </div>
    <div id="save-fab" aria-live="polite">
      <span class="text-xs opacity-80">Unsaved changes</span>
      <button id="save-current" class="px-3 py-1.5 bg-white text-gray-800 rounded-full text-sm font-semibold focus-ring">Save</button>
      <button id="save-all-fab" class="px-3 py-1.5 bg-blue-600 text-white rounded-full text-sm font-semibold hover:bg-blue-700 focus-ring">Save All</button>
    </div>

    <script>
    const disciplines = [
        { id: 'd1', title: 'IDENTIFY TEAM', shortDesc: 'Establish a small group of people with the knowledge, time, and authority to solve the problem.' },
        { id: 'd2', title: 'PROBLEM DESCRIPTION', shortDesc: 'Describe the internal/external problem by identifying "what is wrong with what" and detailing the problem in quantifiable terms.' },
        { id: 'd3', title: 'INTERIM CONTAINMENT', shortDesc: 'Define and implement containment actions to isolate the problem from any customer.' },
        { id: 'd4', title: 'IDENTIFICATION AND VERIFICATION OF ROOT CAUSE', shortDesc: 'Identify all potential causes that could explain why the problem occurred. Isolate and verify the root cause.' },
        { id: 'd5', title: 'SELECTION AND VERIFICATION OF CORRECTIVE ACTION', shortDesc: 'Select the best permanent corrective action to remove the root cause.' },
        { id: 'd6', title: 'IMPLEMENT AND VALIDATE PERMANENT CORRECTIVE ACTION', shortDesc: 'Plan and implement the selected permanent corrective action. Validate the action.' },
        { id: 'd7', title: 'PREVENTIVE ACTION', shortDesc: 'Modify the necessary systems including policies, practices, and procedures to prevent recurrence of this and similar problems.' },
        { id: 'd8', title: 'RECOGNITION', shortDesc: 'Congratulate your team and recognize their collective efforts.' }
    ];
    window.disciplines = disciplines;

     const stepIcons = { d1: 'users', d2: 'file-text', d3: 'shield-check', d4: 'search', d5: 'check-square', d6: 'tool', d7: 'ban', d8: 'award' };

    function getInitialData() {
        const today = new Date();
        const d = (days) => new Date(today.getTime() - (days * 24 * 60 * 60 * 1000));
        const future = (days) => new Date(today.getTime() + (days * 24 * 60 * 60 * 1000));

        const data = {};
        disciplines.forEach(d_item => {
            data[d_item.id] = { status: 'pending', lastUpdated: null, fields: {}, checklist: {} };
        });

        // --- Pre-populated Demo Data ---
        data.d1 = {
            status: 'completed',
            lastUpdated: d(28).toISOString(),
            fields: {
                teamCharter: 'To identify the root cause of the Z-80 bracket failures, implement corrective actions, and prevent recurrence, with a target completion date of ' + future(30).toLocaleDateString() + '.',
                members: [
                    { name: 'Sarah Jenkins', role: 'KPOC', title: 'Quality Engineer', email: 's.jenkins@example.com', phone: '555-123-4567' },
                    { name: 'Tom Wilson', role: 'Champion', title: 'Production Manager', email: 't.wilson@example.com', phone: '555-987-6543' },
                    { name: 'Maria Garcia', role: 'Team Lead', title: 'Materials Scientist', email: 'm.garcia@example.com', phone: '555-234-5678' },
                    { name: 'David Chen', role: 'Team Member', title: 'Supplier Quality Eng.', email: 'd.chen@example.com', phone: '555-876-5432' },
                    { name: 'Frank Miller', role: 'Team Member', title: 'Process Engineer', email: 'f.miller@example.com', phone: '555-456-1234' }
                ]
            },
            checklist: {
                0: true, // Do we have an effective team leader?
                1: true, // Do we have the right people on the team?
                2: true, // Does the team have a clear charter?
                3: false // Is there a communication plan?
            }
        };

        data.d2 = {
            status: 'completed',
            lastUpdated: d(27).toISOString(),
            fields: {
                problemStatement: 'During routine quality checks, it was discovered that the Z-80 mounting brackets from our new supplier (Supplier-B, Lot #B-456) are fracturing under standard operational stress tests. This issue was not present with the previous supplier.',
                briefStatement: 'The new Z-80 mounting brackets are fracturing under standard operational stress.',
                what: 'Z-80 mounting bracket (Part #45-113B) is fracturing.',
                when: d(28).toLocaleDateString(),
                where: 'In-house quality assurance lab, Station 3.',
                who: 'QA Inspector, John Doe.',
                how: 'Standard 50kg load stress test.',
                why: 'Fracturing poses a critical safety risk and will lead to in-field failures.',
                howMany: '157',
                situationBefore: 'Brackets from the previous supplier (Supplier-A) had a 0.01% failure rate. New supplier brackets are failing at a rate of 15% in initial testing.',
                processAudit: [
                    { step: 'Receiving', cause: 'Incorrect material certs', action: 'Yes' },
                    { step: 'Stamping', cause: 'Tool wear', action: 'No' },
                    { step: 'Heat Treatment (Supplier)', cause: 'Incorrect oven temperature/time', action: 'Yes' },
                    { step: 'QA Inspection', cause: 'Hardness test not performed', action: 'Yes' }
                ],
                controlDocs: [
                    { document: 'PFMEA-Z-80', reviewed: 'Yes', rpn: 320 },
                    { document: 'Control Plan CP-112', reviewed: 'Yes', rpn: 280 },
                    { document: 'SOP-QC-11B', reviewed: 'No', rpn: 0 }
                ]
            },
            checklist: { 0: true, 1: true, 2: true, 3: false }
        };

        data.d3 = {
            status: 'completed',
            lastUpdated: d(25).toISOString(),
            fields: {
                containmentActions: [
                    { action: 'Quarantine all stock of Lot #B-456', owner: 'T. Wilson', date: d(27).toISOString().split('T')[0], status: 'Done' },
                    { action: 'Notify downstream customers', owner: 'S. Jenkins', date: d(27).toISOString().split('T')[0], status: 'In Progress' },
                    { action: 'Implement 100% stress test for incoming brackets', owner: 'S. Jenkins', date: d(26).toISOString().split('T')[0], status: 'To Do' }
                ],
                riskItems: [
                    { process: 'Assembly Line 1', risk: 'Yes', containment: 'Yes' },
                    { process: 'Service Part Stock', risk: 'Yes', containment: 'Yes' },
                    { process: 'Finished Goods Warehouse', risk: 'No', containment: 'No' },
                ],
                labels: [
                    { cutoff: 'Lot #B-455', datetime: d(28).toISOString().substring(0, 16), comments: 'Last known good lot' },
                    { cutoff: 'Work Order #9871', datetime: d(27).toISOString().substring(0, 16), comments: 'First known bad lot' }
                ],
                sorting: [
                   { task: 'Warehouse Stock Sort', responsibility: 'QA Team A', toCheck: 2500, ok: 2480, notOk: 20, checked: 2500, date: d(26).toISOString().split('T')[0], comments: '20 failures found' },
                   { task: 'WIP on Line 1 Sort', responsibility: 'QA Team B', toCheck: 500, ok: 491, notOk: 9, checked: 500, date: d(25).toISOString().split('T')[0], comments: '9 failures found' }
                ],
                supplierDescription: 'All inventory from Lot #B-456 has been quarantined and tagged as non-conforming. A 100% inspection and stress test process has been implemented for all incoming Z-80 brackets until the root cause is identified and resolved.',
                actionNotes: 'Contacted Supplier-B and informed them of the issue. They have started an internal investigation. All outbound shipments containing this lot have been stopped.'
            },
            checklist: { 0: true, 1: true, 2: false }
        };

        data.d4 = {
            status: 'in-progress',
            lastUpdated: d(14).toISOString(),
            fields: {
                rootCause: 'Improper heat treatment during the manufacturing process by Supplier-B resulted in reduced material tensile strength, making the brackets brittle.',
                verificationMethod: 'Metallurgical analysis (Rockwell hardness test) of failed parts compared to the engineering specification.',
                verificationSummary: 'Lab analysis confirmed the material hardness of failed brackets is 20% below the required HRC 45 specification. Brackets from a good lot tested within spec.',
                fishbone: [
                    { category: 'Material', cause: 'Incorrect alloy specification', notes: 'Supplier used 6061-T4 instead of 6061-T6 aluminum.' },
                    { category: 'Method', cause: 'Improper heat treatment', notes: 'Oven temperature was not properly calibrated.' },
                    { category: 'Machine', cause: 'Old stamping die', notes: 'Die is showing signs of wear, causing micro-fractures.' }
                ],
                fiveWhys: [
                    { why: 'Why did the bracket fail?', because: 'The material was too brittle and fractured under load.' },
                    { why: 'Why was the material brittle?', because: 'The heat treatment process was not performed to specification.' },
                    { why: 'Why was the process not to spec?', because: 'The oven temperature was too low.' },
                    { why: 'Why was the temperature too low?', because: 'The oven controller is faulty and reads incorrectly.' },
                    { why: 'Why was the controller faulty?', because: 'It was not included in the regular calibration schedule.' }
                ],
                verificationActions: [
                    { action: 'Test hardness of 10 samples from Lot #B-456', owner: 'M. Garcia', date: d(12).toISOString().split('T')[0], status: 'Completed' },
                    { action: 'Review supplier oven calibration logs', owner: 'D. Chen', date: d(11).toISOString().split('T')[0], status: 'Completed' },
                    { action: 'Test hardness of 5 samples from old Lot #A-123', owner: 'M. Garcia', date: d(10).toISOString().split('T')[0], status: 'Completed' }
                ],
                finalRootCauses: [
                    { cause: 'Supplier oven controller not on calibration schedule', category: 'Process', likelihood: 5, severity: 5 },
                    { cause: 'Incoming material hardness not verified', category: 'Process', likelihood: 4, severity: 4 }
                ]
            },
            checklist: { 0: true, 1: true, 2: true, 3: false }
        };

        data.d5 = {
            status: 'in-progress',
            lastUpdated: d(7).toISOString(),
            fields: {
                selectedPCA: '1. Mandate supplier provides certs for heat treatment per batch. 2. Implement mandatory incoming batch testing for material hardness.',
                correctiveActions: [
                    { action: 'Add supplier oven to calibration audit', rootCause: 'It was not included in the regular calibration schedule.', targetDate: d(0).toISOString().split('T')[0], responsibility: 'F. Miller', mistakeProof: false, status: 'In Progress', risk: 150 },
                    { action: 'Update supplier quality manual (QM-S-01) to require heat treatment certification for every batch of part #45-113B.', rootCause: 'It was not included in the regular calibration schedule.', targetDate: d(5).toISOString().split('T')[0], responsibility: 'D. Chen', mistakeProof: true, status: 'Completed', risk: 120 },
                    { action: 'Implement incoming Rockwell hardness test for all lots of part #45-113B.', rootCause: 'The oven controller is faulty and reads incorrectly.', targetDate: d(3).toISOString().split('T')[0], responsibility: 'S. Jenkins', mistakeProof: true, status: 'Verified', risk: 80 }
                ],
                verificationChecklist: [
                    { item: 'Is the supplier oven in the calibration system?', done: false },
                    { item: 'Has the supplier quality manual been updated and approved?', done: true },
                    { item: 'Is the incoming hardness test procedure documented and are inspectors trained?', done: true },
                    { item: 'Has the new test been performed on a new batch?', done: true }
                ]
            }
        };

        data.d6 = {
            status: 'in-progress',
            lastUpdated: d(2).toISOString(),
            fields: {
                proof: 'First batch from Supplier-B with new process controls arrived. 10/10 samples passed hardness testing. Failure rate is 0% on this batch.',
                situationAfter: 'The new process controls appear to be effective. The brackets from the new batch meet all performance and safety standards.',
                implementationPlan: [
                    { action: 'Hardness Test Station Setup', 'start_date': d(10).toISOString().split('T')[0], 'end_date': d(8).toISOString().split('T')[0], 'responsibility': 'S. Jenkins', 'status': 'Completed' },
                    { action: 'Receive New Batch from Supplier', 'start_date': d(8).toISOString().split('T')[0], 'end_date': d(5).toISOString().split('T')[0], 'responsibility': 'D. Chen', 'status': 'Completed' },
                    { action: 'Validate New Batch', 'start_date': d(5).toISOString().split('T')[0], 'end_date': d(2).toISOString().split('T')[0], 'responsibility': 'S. Jenkins', 'status': 'Completed' },
                    { action: 'Full Production Ramp-up', 'start_date': d(1).toISOString().split('T')[0], 'end_date': future(5).toISOString().split('T')[0], 'responsibility': 'T. Wilson', 'status': 'In Progress' }
                ]
            },
            checklist: { 0: true, 1: true, 2: false }
        };

        data.d7 = {
            status: 'in-progress',
            lastUpdated: d(1).toISOString(),
            fields: {
                preventiveActions: [
                    { action: 'Update SOP-QC-11B for mandatory hardness testing', type: 'Corrective', available: true, responsible: 'S. Jenkins', targetDate: future(10).toISOString().split('T')[0], status: 'In Progress', rpn: 80 },
                    { action: 'Add supplier oven to quarterly calibration schedule CP-04', type: 'Preventive', available: true, responsible: 'F. Miller', targetDate: future(20).toISOString().split('T')[0], status: 'Open', rpn: 60 },
                    { action: 'Update New Supplier Onboarding process to include equipment calibration audit', type: 'Preventive', available: false, responsible: 'S. Davis', targetDate: future(45).toISOString().split('T')[0], status: 'Open', rpn: 45 }
                ],
                validationPlan: 'Audit of SOPs and calibration logs will be performed in 3 months. Next scheduled QA training will include the new module.',
                acknowledgements: ['s.jenkins@example.com', 't.wilson@example.com']
            },
            checklist: { 0: true, 1: false, 2: false }
        };

        data.d8 = {
            status: 'pending',
            lastUpdated: null,
            fields: {
                recognitionSummary: 'The cross-functional team successfully identified and resolved a critical material failure, preventing potential field issues and strengthening our supplier quality process. Their diligent work is a model for future problem-solving initiatives.',
                lessonsLearned: '1. Incoming material validation for new suppliers must be more rigorous.\n2. Critical equipment, even at supplier sites, should be considered for our own calibration and process audits.\n3. The 5 Whys analysis was instrumental in drilling down past the immediate cause to the systemic process failure.',
                teamCelebration: 'A team lunch has been scheduled for next Friday to celebrate the successful resolution of this issue.',
                acknowledgements: [
                    { 'team_member': 'Maria Garcia', 'achievements': 'Pinpointed the exact failure mode', 'recognition_type': 'Spot Award' },
                    { 'team_member': 'David Chen', 'achievements': 'Excellent supplier communication and coordination', 'recognition_type': 'Certificate of Appreciation' },
                    { 'team_member': 'Frank Miller', 'achievements': 'Quickly identified the process control gap (calibration schedule)', 'recognition_type': 'Verbal Praise' },
                    { 'team_member': 'Entire Team', 'achievements': 'Collaborative effort to protect the customer and resolve the issue quickly', 'recognition_type': 'Team Lunch' }
                ]
            },
            checklist: { 0: false, 1: false, 2: false }
        };

        return data;
    }

    function ensureCoreStyles(){
      const need = ['../assets/8d.css','../assets/design-system.css'];
      need.forEach(href=>{ if(!document.querySelector(`link[rel="stylesheet"][href="${href}"]`)){ const l=document.createElement('link'); l.rel='stylesheet'; l.href=href; document.head.appendChild(l); }});
    }

    const app = {
        data: {}, _dirty:false,
        init() {
            this.loadData();
            this.renderStepper();
            this.attachEventListeners();
            this.applySidebarState();
            ensureCoreStyles();
            this.handleRouting();
            this.updateStepperStatusColors();
            this.applyStepState();
        },
        loadData() {
            const savedData = localStorage.getItem('8d-data-v2');
            if (savedData) { this.data = JSON.parse(savedData); } else { this.data = getInitialData(); }
            try{
              if(window.DataStore && typeof window.DataStore.get==='function'){
                window.DataStore.get('8d-data-v2').then((cloud)=>{
                  if(cloud && typeof cloud === 'object'){
                    this.data = cloud; this.renderStepper(); this.handleRouting(); this.updateStepperStatusColors();
                  }
                }).catch(()=>{});
              }
            }catch(_){ }
            if(!this.data.meta) this.data.meta = { overallStatus:'Open', assignee:'', team:'', role: localStorage.getItem('8d-role')||'Admin' };
            if(!this.data.audit) this.data.audit = [];

            // Dispatch a custom event to signal that data is ready
            document.dispatchEvent(new CustomEvent('appDataReady'));
        },
        saveData(reason) {
            try{ if(reason){ this.data.audit.push({ ts: new Date().toISOString(), userRole: this.data.meta?.role||'Admin', reason }); } }catch(_){ }
            localStorage.setItem('8d-data-v2', JSON.stringify(this.data));
            try{ if(window.DataStore && typeof window.DataStore.set==='function'){ window.DataStore.set('8d-data-v2', this.data); } }catch(_){ }
            this.updateStepperStatusColors();
            const ind = document.getElementById('autosave-indicator'); if(ind){ ind.textContent = 'All changes saved'; }
            this._dirty = false; this.updateSaveFab();
        },
        renderStepper() {
            const nav = document.getElementById('stepper-nav');
            const stepsHtml = disciplines.map(d => {
                const status = (this.data[d.id]?.status) || 'pending';
                const badge = this.renderStatusBadge(status);
                return `
                <div id="step-container-${d.id}" class="step-container">
                    <a href="#${d.id}" id="nav-${d.id}" data-id="${d.id}" class="step-link block focus-ring" data-tooltip="${d.title} - ${d.shortDesc}">
                        <div class="step flex items-center mb-1">
                            <div class="step-circle z-10">
                                <span class="step-abbr">${d.id.toUpperCase()}</span>
                            </div>
                            <div class="ml-4 p-3 rounded-lg w-full step-content font-semibold text-gray-600 flex justify-between items-center">
                                <span class="flex items-center gap-2">${d.title} <span class="inline-flex items-center gap-1 text-xs font-medium" id="badge-${d.id}">${badge}</span></span>
                                <i data-lucide="chevron-right" class="step-arrow"></i>
                            </div>
                        </div>
                    </a>
                    <div class="step-details ml-16 mb-4 pl-3 pr-2 text-xs text-gray-500 border-l-2 border-gray-200" style="display: none;">
                        <p>${d.shortDesc}</p>
                    </div>
                </div>`;
            }).join('');
            nav.innerHTML = `<div id="stepper-progress"></div>` + stepsHtml;
            this.updateProgressSummary();
            this.updateStepperProgressLine && this.updateStepperProgressLine();
        },
        async loadDisciplineContent(id) {
            const container = document.getElementById('content-container');
            container.classList.add('loading');
            this.showSkeleton && this.showSkeleton(container);
            try {
                const tryPaths = [];
                const base = window.location.pathname.replace(/[^\/]*$/, '');
                tryPaths.push(base + id + '.html');
                tryPaths.push('/' + id + '.html');
                tryPaths.push('./' + id + '.html');
                tryPaths.push(id + '.html');
                let response = null;
                let lastError = null;
                for (const p of tryPaths) {
                    try { response = await fetch(p); if (response && response.ok) break; lastError = new Error(`Not found at ${p}`); } catch (fetchErr) { lastError = fetchErr; }
                }
                if (!response || !response.ok) { console.warn('Fetch attempts failed:', tryPaths, lastError); throw new Error(`File not found: ${id}.html.`); }
                const html = await response.text();
                container.innerHTML = html;
                ensureCoreStyles();
                Array.from(container.querySelectorAll('link[rel="stylesheet"]')).forEach(link=>{ const href = link.getAttribute('href'); if(href && !document.querySelector(`link[rel="stylesheet"][href="${href}"]`)){ const l = document.createElement('link'); l.rel='stylesheet'; l.href=href; document.head.appendChild(l); } link.remove(); });
                const scripts = Array.from(container.querySelectorAll('script'));
                for (const oldScript of scripts) {
                    const newScript = document.createElement('script');
                    if (oldScript.src) {
                        // If the script has a src, we need to handle it carefully to avoid re-execution
                        // For this app, we assume inline scripts are the main concern
                        if (!document.querySelector(`script[src="${oldScript.src}"]`)) {
                            newScript.src = oldScript.src;
                            newScript.async = false; // Ensure sequential execution if needed
                            document.body.appendChild(newScript);
                        }
                    } else {
                        // For inline scripts, just create and append
                        newScript.textContent = oldScript.textContent;
                        document.body.appendChild(newScript);
                    }
                    oldScript.remove(); // Remove the original script from the inert document fragment
                }
                this.populateForm(id);
                if (window.__init8D) window.__init8D(container);
            } catch (error) {
                console.error('Failed to fetch discipline content:', error);
                container.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-lg text-center"><h2 class="text-2xl font-bold text-red-600">Error</h2><p class="mt-2 text-gray-600">Could not load content for ${id.toUpperCase()}.</p></div>`;
            } finally { container.classList.remove('loading'); }
        },
        attachEventListeners() {
            window.addEventListener('hashchange', this.handleRouting.bind(this));
            document.getElementById('sidebar-toggle-btn').addEventListener('click', this.toggleSidebar.bind(this));

            const stepperNav = document.getElementById('stepper-nav');
            stepperNav.addEventListener('click', (e) => {
                const link = e.target.closest('.step-link');
                if (link && !e.target.closest('a')) { // Only toggle if not clicking the main link
                    this.toggleStep(link.dataset.id);
                }
            });

            document.getElementById('expand-all-btn').addEventListener('click', () => this.expandAllSteps());
            document.getElementById('collapse-all-btn').addEventListener('click', () => this.collapseAllSteps());

            window.addEventListener('keydown', (e) => {
                if (e.altKey && e.key === 'ArrowDown') {
                    e.preventDefault();
                    this.expandAllSteps();
                }
                if (e.altKey && e.key === 'ArrowUp') {
                    e.preventDefault();
                    this.collapseAllSteps();
                }
            });

            const contentEl = document.getElementById('content-container');
            contentEl.addEventListener('click', (e) => {
                const target = e.target.closest('#d1-add-member-btn, .remove-member-btn, .remove-row-btn');
                if (!target) return;
                if (target.matches('#d1-add-member-btn')) this.addTeamMember();
                if (target.matches('.remove-member-btn')) this.removeTeamMember(target.dataset.index);
                if (target.matches('.remove-row-btn')) { if(!confirm('Remove this item?')){ e.preventDefault(); e.stopImmediatePropagation(); return; } }
            });
            const menuBtn = document.getElementById('export-toggle');
            const menu = document.getElementById('export-menu');
            if(menuBtn){ menuBtn.addEventListener('click', (e)=>{ e.stopPropagation(); menu.classList.toggle('hidden'); }); document.addEventListener('click', ()=> menu.classList.add('hidden')); }
            const csvBtn = document.getElementById('export-csv');
            const jsonBtn = document.getElementById('export-json');
            const printBtn = document.getElementById('print-pdf');
            if(csvBtn) csvBtn.addEventListener('click', (ev)=>{ ev.preventDefault(); this.exportCurrentToCSV(); });
            if(jsonBtn) jsonBtn.addEventListener('click', (ev)=>{ ev.preventDefault(); this.exportAllToJSON(); });
            if(printBtn) printBtn.addEventListener('click', (ev)=>{ ev.preventDefault(); this.printCurrent(); });
            document.getElementById('content-container').addEventListener('change', (e) => {
                if (e.target.matches('.status-select')) {
                    const id = e.target.dataset.id; this.data[id].status = e.target.value; this.data[id].lastUpdated = new Date().toISOString(); this.saveData('status-change-'+id); this.populateForm(id);
                }
                if (e.target.matches('input[type="checkbox"]')) {
                    const id = e.target.dataset.id; if (this.data[id]) { this.data[id].checklist[e.target.dataset.index] = e.target.checked; this.saveData('checklist-'+id); }
                }
            });
            const fab = document.getElementById('save-fab');
            document.getElementById('save-current').addEventListener('click', ()=>{ const id=(location.hash||'#dashboard').replace('#',''); const disc = disciplines.find(d=>d.id===id); this.saveData('manual-'+(disc?disc.id:'dashboard')); });
            document.getElementById('save-all-fab').addEventListener('click', ()=> this.saveData('manual-save-all'));
            const containerEl = document.getElementById('content-container');
            let saveTimer = null;
            containerEl.addEventListener('input', (e)=>{
              const id = (location.hash||'#dashboard').replace('#','');
              const t = e.target;
              if(!(t instanceof HTMLInputElement || t instanceof HTMLTextAreaElement || t instanceof HTMLSelectElement)) return;
              if(disciplines.some(d=> d.id===id)){
                if(!this.data[id]) return;
                const m = t.id && t.id.startsWith(id+'-') ? t.id.slice((id+'-').length) : null;
                if(m){ const val = (t.type === 'checkbox') ? (t.checked ? 'true' : 'false') : t.value; this.data[id].fields[m] = val; }
                this.data[id].lastUpdated = new Date().toISOString();
              }
              this._dirty = true; this.updateSaveFab(true);
              const ind = document.getElementById('autosave-indicator'); if(ind){ ind.textContent = 'Saving…'; }
              clearTimeout(saveTimer);
              saveTimer = setTimeout(()=> this.saveData('field-change-'+id), 600);
            });
        },
        handleRouting() {
            let hash = (window.location.hash || '').replace('#','');
            if(!hash) { hash = 'dashboard'; window.location.hash = '#dashboard'; }
            const isDiscipline = disciplines.some(d => d.id === hash);
            if (!isDiscipline && hash !== 'dashboard') { hash = 'dashboard'; window.location.hash = '#dashboard'; return; }
            this.loadDisciplineContent(hash);
            this.updateBreadcrumbs(hash);
            document.querySelectorAll('.step-link').forEach(link => link.classList.remove('active'));
            const activeLink = document.getElementById(`nav-${hash}`);
            if (activeLink) activeLink.classList.add('active');
        },
        updateBreadcrumbs(pageId) {
            const breadcrumbEl = document.getElementById('breadcrumb');
            if (!breadcrumbEl) return;

            const page = disciplines.find(d => d.id === pageId);
            const pageTitle = page ? `${page.id.toUpperCase()}: ${page.title}` : 'Dashboard';

            breadcrumbEl.innerHTML = `
              <a href="#dashboard" class="hover:text-blue-600">Home</a>
              <span class="mx-2">/</span>
              <span class="text-gray-700 font-semibold">${pageTitle}</span>
            `;
        },
        populateForm(id) {
            const disciplineData = this.data[id]; if (!disciplineData) return;
            const statusSelect = document.getElementById(`${id}-status-select`); if(statusSelect) statusSelect.value = disciplineData.status;
            const timestamp = document.getElementById(`${id}-timestamp`); if(timestamp) timestamp.textContent = disciplineData.lastUpdated ? new Date(disciplineData.lastUpdated).toLocaleString() : "Never";
            for (const key in disciplineData.fields) { const element = document.getElementById(`${id}-${key}`); if (element) element.value = disciplineData.fields[key] || ''; }
            if (id === 'd8') this.populateD8Summaries();
            for (const key in disciplineData.checklist) { const element = document.getElementById(`${id}-check-${key}`); if (element) element.checked = disciplineData.checklist[key]; }
        },
        populateD8Summaries() {
            const summaryContainer = document.getElementById('d8-causes-summary');
            if (!summaryContainer) return;
            const d4data = this.data.d4;
            if (!d4data || !d4data.fields) {
                summaryContainer.innerHTML = '<p class="ds-caption">D4 data not available.</p>';
                return;
            }
            // Use the fields defined in getInitialData as the source
            const { rootCause, verificationMethod, verificationSummary } = d4data.fields;
            if (!rootCause && !verificationSummary) {
                summaryContainer.innerHTML = '<p class="ds-caption">No root cause analysis has been documented in D4.</p>';
                return;
            }
            const summaryHtml = `
                <dl class="space-y-3">
                    <div>
                        <dt class="font-semibold text-slate-800">Root Cause</dt>
                        <dd class="text-slate-600 pl-2">${rootCause || 'Not specified.'}</dd>
                    </div>
                    <div>
                        <dt class="font-semibold text-slate-800">Verification Method</dt>
                        <dd class="text-slate-600 pl-2">${verificationMethod || 'Not specified.'}</dd>
                    </div>
                    <div>
                        <dt class="font-semibold text-slate-800">Verification Summary</dt>
                        <dd class="text-slate-600 pl-2">${verificationSummary || 'Not specified.'}</dd>
                    </div>
                </dl>
            `;
            summaryContainer.innerHTML = summaryHtml;
        },
        exportCurrentToCSV(){
            const hash = window.location.hash.replace('#','') || 'dashboard';
            const container = document.getElementById('content-container');
            const rows = [];
            container.querySelectorAll('label.label').forEach(label=>{
                const forId = label.getAttribute('for');
                const input = forId ? container.querySelector(`#${forId}`) : null;
                if(input && (input.value||'').trim()){
                    const name = label.textContent.trim().replaceAll(',', ' ');
                    const val = input.value.replaceAll('\n',' ');
                    rows.push(`${name},"${val.replaceAll('"','""')}"`);
                }
            });
            container.querySelectorAll('table.table').forEach(tbl=>{
                const headers = Array.from(tbl.querySelectorAll('thead th')).map(th=>th.textContent.trim().replaceAll(',', ' '));
                if(headers.length){ rows.push(''); rows.push(headers.join(',')); }
                tbl.querySelectorAll('tbody tr').forEach(tr=>{
                    const cols = Array.from(tr.querySelectorAll('td')).map(td=> td.querySelector('input,select,textarea')?.value || td.textContent.trim());
                    rows.push(cols.map(v=>`"${(v||'').toString().replaceAll('"','""')}"`).join(','));
                });
            });
            const csv = rows.join('\n');
            const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `${hash}.csv`; a.click(); URL.revokeObjectURL(url);
        },
        exportAllToJSON(){ const blob = new Blob([JSON.stringify(this.data, null, 2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = '8d-data.json'; a.click(); URL.revokeObjectURL(url); },
        printCurrent(){ const w = window.open('', '_blank'); const title = document.title; const html = document.getElementById('content-container').innerHTML; w.document.write(`<!doctype html><html><head><title>${title}</title><link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css\"></head><body><main class=\"container\">${html}</main><script>setTimeout(()=>window.print(), 200);<\\/script></body></html>`); w.document.close(); },
        toggleSidebar() {
            const container = document.getElementById('app-container');
            const isCollapsed = container.classList.toggle('sidebar-collapsed');
            localStorage.setItem('sidebarCollapsed', isCollapsed);
            this.updateSidebarToggleUI(isCollapsed);
        },
        applySidebarState() { const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true'; if (isCollapsed) { document.getElementById('app-container').classList.add('sidebar-collapsed'); } this.updateSidebarToggleUI(isCollapsed); },
        renderStatusBadge(status){ const map = { 'pending': '<span class="px-2 py-0.5 rounded-full bg-gray-200 text-gray-700">Pending</span>', 'in-progress': '<span class="px-2 py-0.5 rounded-full bg-amber-500 text-white">In Progress</span>', 'completed': '<span class="px-2 py-0.5 rounded-full bg-emerald-500 text-white">Completed</span>' }; return map[status] || map['pending']; },
        updateProgressSummary(){ const done = disciplines.filter(d=>this.data[d.id]?.status==='completed').length; const total = disciplines.length; const el = document.getElementById('progress-summary'); if(el) el.textContent = `Progress: ${done}/${total} steps completed`; const bar=document.getElementById('overall-progress-bar'); if(bar){ const pct = Math.max(0, Math.min(100, (done/Math.max(1,total))*100)); bar.style.width = pct+'%'; } },
        updateStepperStatusColors() {
            disciplines.forEach(d => {
                const link = document.getElementById(`nav-${d.id}`);
                if(link && this.data[d.id]) {
                    link.classList.remove('status-pending', 'status-in-progress', 'status-completed');
                    const st = this.data[d.id].status; link.classList.add(`status-${st}`);
                    const badgeHost = document.getElementById(`badge-${d.id}`); if(badgeHost) badgeHost.innerHTML = this.renderStatusBadge(st);
                }
            });
            this.updateProgressSummary(); this.updateStepperProgressLine && this.updateStepperProgressLine();
        },
        updateSidebarToggleUI(isCollapsed){ const btn = document.getElementById('sidebar-toggle-btn'); const icon = document.getElementById('toggle-btn-icon'); const label = btn ? btn.querySelector('.sidebar-text') : null; if(label) label.textContent = isCollapsed ? 'Expand' : 'Collapse'; if(btn) btn.setAttribute('aria-expanded', (!isCollapsed).toString()); if(icon) icon.setAttribute('aria-hidden','true'); },

        toggleStep(id, forceState) {
            const container = document.getElementById(`step-container-${id}`);
            const details = container?.querySelector('.step-details');
            if (!details) return;

            const isExpanded = details.style.display !== 'none';
            const shouldBeExpanded = forceState !== undefined ? forceState : !isExpanded;

            details.style.display = shouldBeExpanded ? 'block' : 'none';
            this.saveStepState();
        },

        expandAllSteps() {
            disciplines.forEach(d => this.toggleStep(d.id, true));
        },

        collapseAllSteps() {
            disciplines.forEach(d => this.toggleStep(d.id, false));
        },

        saveStepState() {
            const state = {};
            disciplines.forEach(d => {
                const details = document.getElementById(`step-container-${d.id}`)?.querySelector('.step-details');
                state[d.id] = details ? details.style.display !== 'none' : false;
            });
            sessionStorage.setItem('stepperState', JSON.stringify(state));
        },

        applyStepState() {
            const state = JSON.parse(sessionStorage.getItem('stepperState') || '{}');
            disciplines.forEach(d => {
                this.toggleStep(d.id, state[d.id] === true);
            });
        },

        showSkeleton(container){ const host = container || document.getElementById('content-container'); if(!host) return; host.innerHTML = `
          <div class="card">
            <div class="flex items-center justify-between">
              <div class="skeleton" style="height:24px;width:220px;border-radius:6px"></div>
              <div class="skeleton" style="height:36px;width:120px;border-radius:8px"></div>
            </div>
            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="skeleton" style="height:140px;border-radius:10px"></div>
              <div class="skeleton" style="height:140px;border-radius:10px"></div>
            </div>
          </div>`; },
        updateSaveFab(force){ const bar = document.getElementById('save-fab'); if(!bar) return; bar.classList.toggle('visible', !!(force || this._dirty)); },
        updateStepperProgressLine(){ const nav = document.getElementById('stepper-nav'); const line = document.getElementById('stepper-progress'); if(!nav || !line) return; const steps = Array.from(nav.querySelectorAll('.step')); if(!steps.length) { line.style.height = '0px'; return; } let lastIdx = -1; disciplines.forEach((d, i)=>{ if(app.data[d.id]?.status === 'completed') lastIdx = i; }); if(lastIdx < 0){ line.style.height = '0px'; return; } const targetStep = steps[Math.min(lastIdx, steps.length-1)]; const navTop = nav.getBoundingClientRect().top; const stepRect = targetStep.getBoundingClientRect(); const center = stepRect.top - navTop + (stepRect.height/2); const offsetTop = 20; const h = Math.max(0, center - offsetTop); line.style.height = h + 'px'; }
    };

    window.app = app;
    document.addEventListener('DOMContentLoaded', () => { app.init(); });

    // --- Global Toast Notification Function ---
    window.showToast = function(message, type = 'info') {
        const container = document.getElementById('toast-container');
        if (!container) return;

        const toast = document.createElement('div');
        const toastTypeClass = `ds-toast--${type}`;
        toast.className = `ds-toast ${toastTypeClass}`;

        const icon = document.createElement('i');
        const iconMap = { 'success': 'check-circle', 'danger': 'x-circle', 'warning': 'alert-triangle', 'info': 'info' };
        icon.dataset.lucide = iconMap[type] || 'info';

        const text = document.createElement('span');
        text.textContent = message;

        toast.appendChild(icon);
        toast.appendChild(text);

        if (window.lucide) window.lucide.createIcons();

        container.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 4000);
    }
    </script>

<script>
(function(){
  function $(id){return document.getElementById(id)}
  function qsa(sel, ctx=document){return Array.from((ctx||document).querySelectorAll(sel))}
  function createEl(html){ const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstChild; }
  function nowISO(){return new Date().toISOString()}

  function ensureStyle(){
    if(document.getElementById('extras-style')) return;
    const s=document.createElement('style'); s.id='extras-style'; s.textContent = `
      .card[data-collapsed="true"] > *:not(.header){ display:none }
      .disabled-ui { opacity:0.6; pointer-events:none }
      #autosave-indicator { min-width:140px }
    `; document.head.appendChild(s);
  }

  function ensureContextBar(){
    const bar = $('context-bar'); if(!bar) return null; return bar;
  }

  function injectToolbarExtras(){
    const cbar = ensureContextBar(); if(!cbar || $('quick-jump')) return;
    const extras = createEl(`
      <div class="flex items-center gap-2 flex-wrap w-full">
        <select id="quick-jump" class="px-2 py-2 bg-white border border-gray-200 rounded-lg text-sm">
          <option value="">Jump to…</option>
          <option value="d1">D1</option><option value="d2">D2</option><option value="d3">D3</option><option value="d4">D4</option><option value="d5">D5</option><option value="d6">D6</option><option value="d7">D7</option><option value="d8">D8</option>
        </select>
        <select id="view-role" class="px-2 py-2 bg-white border border-gray-200 rounded-lg text-sm">
          <option>Admin</option>
          <option>Team Member</option>
          <option>Viewer</option>
        </select>
        <select id="overall-status" class="px-2 py-2 bg-white border border-gray-200 rounded-lg text-sm">
          <option value="Open">Open</option>
          <option value="In Review">In Review</option>
          <option value="Closed">Closed</option>
          <option value="Archived">Archived</option>
        </select>
        <input id="global-assignee" class="px-2 py-2 bg-white border border-gray-200 rounded-lg text-sm" placeholder="Assignee" />
        <input id="global-team" class="px-2 py-2 bg-white border border-gray-200 rounded-lg text-sm" placeholder="Team" />
        <a id="nc-link" href="../NC Listing Page.html" class="px-3 py-2 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 text-sm font-semibold focus-ring" title="Open NC Report"><i data-lucide="link" class="mr-1"></i> NC Report</a>
        <button id="show-audit" class="px-3 py-2 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 text-sm font-semibold focus-ring"><i data-lucide="clock" class="mr-1"></i> Audit</button>
        <span id="autosave-indicator" class="ml-auto text-xs text-gray-500"></span>
      </div>`);
    cbar.appendChild(extras);
  }

  function patchApp(){
    if(!window.app) return;
    const app = window.app;
    if(!app.data) app.data = {};
    if(!app.data.meta) app.data.meta = { overallStatus:'Open', assignee:'', team:'', role: localStorage.getItem('8d-role')||'Admin' };
    if(!app.data.audit) app.data.audit = [];

    const origSave = app.saveData.bind(app);
    app.saveData = function(reason){ try{ if(reason){ this.data.audit.push({ ts: nowISO(), userRole: this.data.meta.role, reason }); } }catch(e){}
      origSave(reason);
      const ind = $('autosave-indicator'); if(ind){ ind.textContent = 'All changes saved'; }
      this._dirty = false; this.updateSaveFab(); this.updateStepperStatusColors(); };

    const origInit = app.init.bind(app);
    app.init = function(){ this.loadData(); origInit(); ensureStyle(); injectToolbarExtras(); bindGlobalControls(this); applyRoleUI(); const ind=$('autosave-indicator'); if(ind) ind.textContent=''; setInterval(()=>{ this.saveData('interval-autosave'); }, 180000); };

    const origUpdate = app.updateStepperStatusColors.bind(app);
    app.updateStepperStatusColors = function(){ origUpdate(); (window.disciplines||[]).forEach(d=>{ const warn = this.data[d.id]?.hasWarnings; const link = $('nav-'+d.id); if(!link) return; const content = link.querySelector('.step-content'); if(!content) return; let icon = content.querySelector('.warn-icon'); if(warn){ if(!icon){ icon = createEl('<span class="warn-icon text-amber-600 ml-2" title="Validation issues"><i data-lucide="alert-triangle"></i></span>'); content.appendChild(icon); } } else if(icon){ icon.remove(); } }); const ind=$('autosave-indicator'); if(ind && ind.textContent==='Saving…'){ ind.textContent='All changes saved'; } };

    function markValidationForCurrent(id){ const container = $('content-container'); let ok = true; qsa('[data-required]', container).forEach(el=>{ const tag = el.tagName; if(tag!=='INPUT' && tag!=='TEXTAREA' && tag!=='SELECT') return; const val=(el.value||'').trim(); if(!val){ ok=false; el.classList.add('invalid'); el.setAttribute('aria-invalid','true'); } else { el.classList.remove('invalid'); el.removeAttribute('aria-invalid'); } }); app.data[id].hasWarnings = !ok; app.saveData('validation-scan-'+id); }

    const containerEl = $('content-container'); let saveTimer=null;
    containerEl.addEventListener('input', (e)=>{ const id=(location.hash||'#dashboard').replace('#',''); const t=e.target; if(t && t.hasAttribute && t.hasAttribute('data-required')){ markValidationForCurrent(id); } app._dirty=true; app.updateSaveFab(true); clearTimeout(saveTimer); saveTimer=setTimeout(()=> app.saveData('field-change-'+id), 600); });

    containerEl.addEventListener('blur', (e)=>{ const t=e.target; if(t && t.hasAttribute && t.hasAttribute('data-required')){ const id=(location.hash||'#dashboard').replace('#',''); markValidationForCurrent(id); } }, true);

    function bindGlobalControls(appRef){ $('quick-jump')?.addEventListener('change', (e)=>{ const v=e.target.value; if(v){ location.hash = '#'+v; e.target.value=''; }});
      const roleSel=$('view-role'); if(roleSel){ roleSel.value = appRef.data.meta.role||'Admin'; roleSel.addEventListener('change',()=>{ appRef.data.meta.role = roleSel.value; localStorage.setItem('8d-role', roleSel.value); appRef.saveData('role-change'); applyRoleUI(); }); }
      const os=$('overall-status'); if(os){ os.value = appRef.data.meta.overallStatus||'Open'; os.addEventListener('change',()=>{ appRef.data.meta.overallStatus=os.value; appRef.saveData('overall-status'); }); }
      const asg=$('global-assignee'); const team=$('global-team'); if(asg){ asg.value = appRef.data.meta.assignee||''; asg.addEventListener('input',()=>{ appRef.data.meta.assignee=asg.value; appRef.saveData('assignee'); }); } if(team){ team.value = appRef.data.meta.team||''; team.addEventListener('input',()=>{ appRef.data.meta.team=team.value; appRef.saveData('team'); }); }
      $('show-audit')?.addEventListener('click', showAuditLog);
    }

    function applyRoleUI(){ const role = app.data.meta.role||'Admin'; const container = $('content-container'); const toolbar = $('context-bar'); qsa('input,select,textarea,button', container).forEach(el=>{ el.disabled=false; el.classList.remove('disabled-ui'); }); qsa('#overall-status, #global-assignee, #global-team', toolbar).forEach(el=>{ el.disabled=false; el.classList.remove('disabled-ui'); }); if(role === 'Viewer'){ qsa('input,select,textarea,button', container).forEach(el=>{ el.disabled=true; el.classList.add('disabled-ui'); }); qsa('#overall-status, #global-assignee, #global-team', toolbar).forEach(el=>{ el.disabled=true; el.classList.add('disabled-ui'); }); } else if(role === 'Team Member'){ qsa('#overall-status, #global-assignee, #global-team', toolbar).forEach(el=>{ el.disabled=true; el.classList.add('disabled-ui'); }); } }

    function showAuditLog(){ const modal = createEl('<div id="audit-modal" class="modal-overlay"></div>'); const card = createEl('<div class="card modal-card"></div>'); const head = createEl('<div class="flex-between"><div class="h-title">Audit Trail</div><button class="icon-btn" id="audit-close" aria-label="Close">✕</button></div>'); const list = createEl('<div class="mt-small" style="max-height:60vh;overflow:auto"></div>'); const logs = (app.data.audit||[]).slice().reverse(); list.innerHTML = logs.length ? `<table class="table"><thead><tr><th>When</th><th>Who</th><th>What</th></tr></thead><tbody>${logs.map(l=>`<tr><td>${new Date(l.ts).toLocaleString()}</td><td>${l.userRole||''}</td><td>${l.reason||''}</td></tr>`).join('')}</tbody></table>` : '<div class="small text-gray-600">No entries yet.</div>'; card.appendChild(head); card.appendChild(list); modal.appendChild(card); document.body.appendChild(modal); modal.addEventListener('click', (e)=>{ if(e.target.id==='audit-modal' || e.target.id==='audit-close'){ modal.remove(); }}); }

    ensureStyle(); injectToolbarExtras();
    patchApp();
  })();
</script>
  <script src="../assets/data-store.js" defer></script>
  <script src="../assets/app-shell.js" defer></script>
  <script>
  // --- Command Palette Logic ---
  (function() {
    const palette = document.getElementById('command-palette');
    const input = document.getElementById('command-input');
    const list = document.getElementById('command-list');

    if (!palette || !input || !list) return;

    const commands = [
      { name: 'Go to Dashboard', action: () => { location.hash = '#dashboard'; }},
      ...window.disciplines.map(d => ({
        name: `Go to ${d.id.toUpperCase()}: ${d.title}`,
        action: () => { location.hash = `#${d.id}`; }
      })),
      { name: 'Toggle Sidebar', action: () => { window.app?.toggleSidebar(); }},
      { name: 'Export All to JSON', action: () => { window.app?.exportAllToJSON(); }},
      { name: 'Print Current View', action: () => { window.app?.printCurrent(); }}
    ];

    function renderCommands(filter = '') {
      list.innerHTML = '';
      const filtered = commands.filter(c => c.name.toLowerCase().includes(filter.toLowerCase()));

      filtered.forEach((command, index) => {
        const li = document.createElement('li');
        li.className = 'px-4 py-3 border-b border-slate-100 cursor-pointer hover:bg-slate-50';
        if (index === 0) li.classList.add('bg-slate-100'); // Highlight first item
        li.textContent = command.name;
        li.addEventListener('click', () => {
          command.action();
          closePalette();
        });
        list.appendChild(li);
      });
    }

    function openPalette() {
      renderCommands();
      palette.style.display = 'flex';
      input.focus();
    }

    function closePalette() {
      input.value = '';
      palette.style.display = 'none';
    }

    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        openPalette();
      }
      if (e.key === 'Escape') {
        closePalette();
      }
    });

    input.addEventListener('input', () => {
      renderCommands(input.value);
    });

    palette.addEventListener('click', (e) => {
      if (e.target === palette) {
        closePalette();
      }
    });
  })();
  </script>

  <!-- Command Palette -->
  <div id="command-palette" class="fixed inset-0 bg-slate-900/50 z-50 hidden items-start justify-center pt-20">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg overflow-hidden">
      <div class="p-2 border-b">
        <input id="command-input" type="text" placeholder="Type a command or search..." class="w-full px-3 py-2 text-lg bg-transparent focus:outline-none">
      </div>
      <ul id="command-list" class="max-h-96 overflow-y-auto">
        <!-- Commands will be injected by JS -->
      </ul>
    </div>
  </div>
  <div id="toast-container" class="fixed top-5 right-5 z-[100] space-y-2"></div>
</body>
</html>
