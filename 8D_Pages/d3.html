<!-- D3 â€” Interim Containment -->
<div class="space-y-6">

  <!-- Actions & Planning Card -->
  <div class="ds-card">
    <div class="ds-card__header">
      <h3 class="ds-h3">Actions & Planning</h3>
    </div>
    <div class="ds-card__body space-y-6">
      <div>
        <label class="ds-caption" for="d3-supplierDescription">3A. Supplier Description of Problem / POV</label>
        <textarea id="d3-supplierDescription" class="ds-textarea" placeholder="Enter the supplier's perspective on the issue..."></textarea>
      </div>

      <!-- Immediate Actions Table -->
      <div>
        <h4 class="font-semibold text-slate-700">3B. Immediate Actions & Responsibility</h4>
        <div class="overflow-x-auto mt-2">
          <table id="d3-actions" class="ds-table w-full">
            <thead>
              <tr><th>Action</th><th>Responsibility</th><th>Target Date</th><th>Status</th><th class="w-12"></th></tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr><td colspan="5"><button class="add-row-btn ds-btn ds-btn--tertiary w-full"><i data-lucide="plus"></i> Add Action</button></td></tr>
            </tfoot>
            <template>
              <tr>
                <td><input class="ds-input" placeholder="Describe action"/></td>
                <td><input class="ds-input" placeholder="Owner"/></td>
                <td><input class="ds-input" type="date"/></td>
                <td><select class="ds-select"><option>Assigned</option><option>In Progress</option><option>Done</option></select></td>
                <td><button class="remove-row-btn ds-btn-icon ds-btn-icon--danger"><i data-lucide="trash-2"></i></button></td>
              </tr>
            </template>
          </table>
        </div>
      </div>

      <!-- Kanban View -->
      <div>
        <h4 class="font-semibold text-slate-700">Immediate Actions (Kanban)</h4>
        <div class="mt-2">
          <input id="d3-new-action" class="ds-input" placeholder="Type a new action and press Enter to add to 'To Do'" />
        </div>
        <div id="d3-kanban" class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
          <div>
            <h5 class="font-bold text-sm text-slate-600 mb-2">To Do</h5>
            <div class="p-3 bg-slate-50 rounded-lg min-h-[160px] space-y-2" id="d3-col-todo"></div>
          </div>
          <div>
            <h5 class="font-bold text-sm text-slate-600 mb-2">In Progress</h5>
            <div class="p-3 bg-slate-50 rounded-lg min-h-[160px] space-y-2" id="d3-col-inprogress"></div>
          </div>
          <div>
            <h5 class="font-bold text-sm text-slate-600 mb-2">Done</h5>
            <div class="p-3 bg-slate-50 rounded-lg min-h-[160px] space-y-2" id="d3-col-done"></div>
          </div>
        </div>
      </div>

      <div>
        <label class="ds-caption" for="d3-actionNotes">3C. Immediate Action Notes</label>
        <textarea id="d3-actionNotes" class="ds-textarea" placeholder="Add any relevant notes about the immediate actions..."></textarea>
      </div>
    </div>
  </div>

  <!-- Risk Assessment & Verification Card -->
  <div class="ds-card">
    <div class="ds-card__header">
      <h3 class="ds-h3">Risk Assessment & Part Verification</h3>
    </div>
    <div class="ds-card__body space-y-8">
      <!-- Risk Panel -->
      <div>
        <h4 class="font-semibold text-slate-700 mb-2">Products/Platforms at Risk</h4>
        <input class="ds-input table-filter mb-4" placeholder="Filter by process or part number..." data-for="#d3-risk" />
        <div class="overflow-x-auto">
          <table id="d3-risk" class="ds-table w-full">
            <thead><tr><th>Process/Part Number</th><th>Risk of Same Error?</th><th>Add to Containment?</th><th class="w-12"></th></tr></thead>
            <tbody></tbody>
            <tfoot><tr><td colspan="4"><button class="add-row-btn ds-btn ds-btn--tertiary w-full"><i data-lucide="plus"></i> Add Item</button></td></tr></tfoot>
            <template><tr><td><input class="ds-input"/></td><td><select class="ds-select"><option>Yes</option><option>No</option></select></td><td><select class="ds-select"><option>Yes</option><option>No</option></select></td><td><button class="remove-row-btn ds-btn-icon ds-btn-icon--danger"><i data-lucide="trash-2"></i></button></td></tr></template>
          </table>
        </div>
      </div>
      <!-- Labels Panel -->
      <div>
        <h4 class="font-semibold text-slate-700 mb-2">Identification / Labelling</h4>
        <input class="ds-input table-filter mb-4" placeholder="Filter by cut off number or comments..." data-for="#d3-labels" />
        <div class="overflow-x-auto">
          <table id="d3-labels" class="ds-table w-full">
            <thead><tr><th>Cut Off Number</th><th>Date / Time</th><th>Image</th><th>Comments</th><th class="w-12"></th></tr></thead>
            <tbody></tbody>
            <tfoot><tr><td colspan="5"><button class="add-row-btn ds-btn ds-btn--tertiary w-full"><i data-lucide="plus"></i> Add Label</button></td></tr></tfoot>
            <template>
              <tr>
                <td><input class="ds-input"/></td><td><input class="ds-input" type="datetime-local"/></td>
                <td><input class="ds-input preview-file" type="file"/></td><td><input class="ds-input"/></td>
                <td><button class="remove-row-btn ds-btn-icon ds-btn-icon--danger"><i data-lucide="trash-2"></i></button></td>
              </tr>
            </template>
          </table>
        </div>
      </div>
      <!-- Sort Panel -->
      <div>
        <h4 class="font-semibold text-slate-700 mb-2">Sorting / Containment</h4>
        <input class="ds-input table-filter mb-4" placeholder="Filter by task or responsibility..." data-for="#d3-sort" />
        <div class="overflow-x-auto">
          <table id="d3-sort" class="ds-table w-full">
            <thead><tr><th>Task/Indicators</th><th>Resp + Target Date</th><th>Qty to Check</th><th>OK Qty</th><th>Not OK Qty</th><th>Total Checked</th><th>Activity Date</th><th>Comments</th><th class="w-12"></th></tr></thead>
            <tbody></tbody>
            <tfoot><tr><td colspan="9"><button class="add-row-btn ds-btn ds-btn--tertiary w-full"><i data-lucide="plus"></i> Add Sort Activity</button></td></tr></tfoot>
            <template>
              <tr>
                <td><input class="ds-input"/></td>
                <td>
                  <input class="ds-input mb-1" placeholder="Responsibility" />
                  <input class="ds-input" type="date" placeholder="Target Date"/>
                </td>
                <td><input class="ds-input qty-total" type="number"/></td><td><input class="ds-input qty-ok" type="number"/></td>
                <td><input class="ds-input qty-nok" type="number"/></td><td><input class="ds-input qty-checked" type="number" disabled /></td>
                <td><input class="ds-input" type="date"/></td><td><input class="ds-input"/></td>
                <td><button class="remove-row-btn ds-btn-icon ds-btn-icon--danger"><i data-lucide="trash-2"></i></button></td>
              </tr>
            </template>
          </table>
        </div>
      </div>
    </div>
    <div class="ds-card__body border-t border-slate-200">
        <label class="ds-caption" for="d3-docs">3G. Supporting Documents</label>
        <input id="d3-docs" class="ds-input preview-file mt-1" type="file" multiple />
        <div class="file-preview mt-2"></div>
    </div>
  </div>

  <!-- Visuals Card -->
  <div class="ds-card">
    <div class="ds-card__header">
      <h3 class="ds-h3">Visual Parts Flow Diagram</h3>
      <p class="ds-caption">Upload a diagram showing where parts are held, sorted, and released.</p>
    </div>
    <div class="ds-card__body" id="d3-flow-zone">
      <input class="ds-input preview-file" id="d3-flow-diagram" type="file" />
      <div class="file-preview mt-2"></div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<style>
  .kanban-card.dragging { opacity: 0.5; transform: scale(1.05); }
  .kanban-col.drag-over { background-color: #e0f2fe; }
</style>
<script>
  if (window.__init8D) {
    window.__init8D(document);
  }

  (function() {
    const todoCol = document.getElementById('d3-col-todo');
    const actionsTable = document.getElementById('d3-actions');
    const actionsTableBody = actionsTable?.querySelector('tbody');
    const kanbanContainer = document.getElementById('d3-kanban');

    if (!todoCol || !actionsTableBody || !kanbanContainer) {
      console.warn("D3 Kanban automation script: Required elements not found.");
      return;
    }

    let draggedCard = null;

    // --- Drag and Drop Logic ---
    kanbanContainer.addEventListener('dragstart', (e) => {
      if (e.target.classList.contains('kanban-card')) {
        draggedCard = e.target;
        setTimeout(() => e.target.classList.add('dragging'), 0);
      }
    });

    kanbanContainer.addEventListener('dragend', (e) => {
      if (draggedCard) {
        draggedCard.classList.remove('dragging');
        draggedCard = null;
      }
    });

    kanbanContainer.addEventListener('dragover', (e) => {
      e.preventDefault();
      const column = e.target.closest('.kanban-col');
      if (column) {
        column.classList.add('drag-over');
      }
    });

    kanbanContainer.addEventListener('dragleave', (e) => {
      const column = e.target.closest('.kanban-col');
      if (column) {
        column.classList.remove('drag-over');
      }
    });

    kanbanContainer.addEventListener('drop', (e) => {
      e.preventDefault();
      const column = e.target.closest('.kanban-col');
      if (column && draggedCard) {
        column.classList.remove('drag-over');
        column.appendChild(draggedCard);

        // Update the status in the corresponding table row
        const cardId = draggedCard.id;
        const actionInput = actionsTable.querySelector(`[data-controls-card="${cardId}"]`);
        const tableRow = actionInput?.closest('tr');
        const statusSelect = tableRow?.querySelector('select');

        if (statusSelect) {
          let newStatus = 'Assigned'; // Default
          if (column.id === 'd3-col-inprogress') newStatus = 'In Progress';
          if (column.id === 'd3-col-done') newStatus = 'Done';
          statusSelect.value = newStatus;
          // Dispatch event to notify framework of the change
          statusSelect.dispatchEvent(new Event('change', { bubbles: true }));
        }
      }
    });

    // --- Kanban Automation via MutationObserver ---
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        mutation.addedNodes.forEach((node) => {
          if (node.nodeType === 1 && node.tagName === 'TR') {
            const actionInput = node.querySelector('input[placeholder="Describe action"]');
            const statusSelect = node.querySelector('select');
            if (!actionInput || !statusSelect) return;

            const card = document.createElement('div');
            card.className = 'kanban-card p-3 bg-white rounded-lg border shadow-sm cursor-grab';
            card.draggable = true;
            card.innerHTML = `<p class="text-sm font-semibold text-slate-800">${actionInput.value || 'New Action'}</p>`;

            const uniqueId = 'd3-kanban-card-' + Date.now();
            card.id = uniqueId;
            actionInput.setAttribute('data-controls-card', uniqueId);
            statusSelect.setAttribute('data-controls-card', uniqueId);

            todoCol.appendChild(card);

            actionInput.addEventListener('input', () => {
              const controlledCard = document.getElementById(uniqueId);
              if (controlledCard) {
                const p = controlledCard.querySelector('p');
                if (p) p.textContent = actionInput.value;
              }
            });

            // Sync status changes from table TO kanban
            statusSelect.addEventListener('change', () => {
              const controlledCard = document.getElementById(uniqueId);
              if (!controlledCard) return;

              let targetCol = todoCol;
              if (statusSelect.value === 'In Progress') targetCol = document.getElementById('d3-col-inprogress');
              if (statusSelect.value === 'Done') targetCol = document.getElementById('d3-col-done');

              if(targetCol) targetCol.appendChild(controlledCard);
            });
          }
        });
      });
    });

    observer.observe(actionsTableBody, { childList: true });

    // Add class to columns for easier targeting
    kanbanContainer.querySelectorAll('div[id^="d3-col-"]').forEach(col => col.classList.add('kanban-col'));
  })();
</script>