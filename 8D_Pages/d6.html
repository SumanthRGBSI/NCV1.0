<!-- D6 — Implement & Validate Corrective Actions -->
<div class="space-y-6">

  <!-- Implementation Tracking Card -->
  <div class="ds-card">
    <div class="ds-card__header">
      <h3 class="ds-h3">6A. Implementation Tracking</h3>
    </div>
    <div class="ds-card__body">
      <div class="overflow-x-auto">
        <table id="d6-impl" class="ds-table w-full">
          <thead class="text-sm">
            <tr>
              <th>Permanent Corrective Action</th>
              <th>Target Date</th>
              <th>Error Proofing Type</th>
              <th>Error Proofing Level</th>
              <th>Error Proof Impact</th>
              <th>Applied to similar risks?</th>
              <th>Qty Parts</th>
              <th>Qty Places/Tools</th>
              <th>Error Proofing Score</th>
              <th>Responsibility</th>
              <th>Effectiveness</th>
              <th>Status</th>
              <th>History</th>
              <th class="w-12"></th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr><td colspan="14"><button class="add-row-btn ds-btn ds-btn--tertiary w-full"><i data-lucide="plus"></i> Add Implementation</button></td></tr>
          </tfoot>
          <template>
            <tr>
              <td><input class="ds-input impl-action" placeholder="Action from D5"/></td>
              <td><input class="ds-input" type="date"/></td>
              <td>
                <select class="ds-select">
                  <option>Detection</option>
                  <option>Warning</option>
                  <option>Control</option>
                  <option>Shutdown</option>
                </select>
              </td>
              <td><input class="ds-input" type="number" min="1" max="5" placeholder="Level"/></td>
              <td><input class="ds-input" type="number" min="1" max="5" placeholder="Impact"/></td>
              <td><select class="ds-select"><option>Yes</option><option>No</option></select></td>
              <td><input class="ds-input" type="number" placeholder="Qty"/></td>
              <td><input class="ds-input" type="number" placeholder="Qty"/></td>
              <td><input class="ds-input" type="number" disabled placeholder="Score"/></td>
              <td><input class="ds-input" placeholder="Owner"/></td>
              <td><input class="ds-input" placeholder="e.g., 95% reduction"/></td>
              <td><select class="ds-select"><option>Open</option><option>In Progress</option><option>Completed</option></select></td>
              <td><button class="ds-btn ds-btn--secondary ds-btn--sm w-full"><i data-lucide="history"></i> View</button></td>
              <td><button class="remove-row-btn ds-btn-icon ds-btn-icon--danger"><i data-lucide="trash-2"></i></button></td>
            </tr>
          </template>
        </table>
      </div>
    </div>
  </div>

  <!-- Validation & Comparison Card -->
  <div class="ds-card">
    <div class="ds-card__header">
        <h3 class="ds-h3">Validation & Comparison</h3>
    </div>
    <div class="ds-card__body grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- KPI Dashboard -->
        <div class="space-y-4">
            <h4 class="font-semibold text-slate-700">KPI Dashboard</h4>
            <div>
                <label class="ds-caption">Defect Rate (Before / After)</label>
                <div class="flex items-center gap-2">
                    <input id="kpi-def-before" class="ds-input" type="number" placeholder="Before"/>
                    <span class="text-slate-400">→</span>
                    <input id="kpi-def-after" class="ds-input" type="number" placeholder="After"/>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-2.5 mt-2">
                    <div id="kpi-def-bar" class="bg-emerald-500 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>
            <div>
                <label class="ds-caption">RPN (Before / After)</label>
                <div class="flex items-center gap-2">
                    <input id="kpi-rpn-before" class="ds-input" type="number" placeholder="Before"/>
                    <span class="text-slate-400">→</span>
                    <input id="kpi-rpn-after" class="ds-input" type="number" placeholder="After"/>
                </div>
                 <div class="w-full bg-slate-200 rounded-full h-2.5 mt-2">
                    <div id="kpi-rpn-bar" class="bg-emerald-500 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>
        </div>
        <!-- Before vs After Comparison -->
        <div class="space-y-4">
            <h4 class="font-semibold text-slate-700">Before vs. After Comparison</h4>
            <div class="grid grid-cols-2 gap-4">
                 <div>
                    <p class="ds-caption">Before (from D2)</p>
                    <div id="d6-compare-before" class="p-2 bg-slate-50 rounded-lg min-h-[80px] mt-1"></div>
                </div>
                <div>
                    <p class="ds-caption">After (from D6)</p>
                    <div id="d6-compare-after" class="p-2 bg-slate-50 rounded-lg min-h-[80px] mt-1"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="ds-card__body border-t border-slate-200 space-y-4">
        <div>
            <label class="ds-caption" for="d6-proof">6B. Proof of Effectiveness</label>
            <textarea id="d6-proof" class="ds-textarea" placeholder="Describe how the effectiveness of the actions was proven..."></textarea>
        </div>
        <div>
            <label class="ds-caption" for="d6-situationAfter">6C. Situation After Countermeasure</label>
            <textarea id="d6-situationAfter" class="ds-textarea" placeholder="Describe the new state after the countermeasures were implemented..."></textarea>
        </div>
        <div>
            <label class="ds-caption" for="d6-after-graphs">6D. Situation After (Graphs / Images)</label>
            <input id="d6-after-graphs" class="ds-input preview-file mt-1" type="file" multiple />
            <div class="file-preview mt-2"></div>
        </div>
    </div>
  </div>

  <!-- Verification & Sign-off Card -->
  <div class="ds-card">
    <div class="ds-card__header">
      <h3 class="ds-h3">6E. Improvement Verification & Sign-off</h3>
    </div>
    <div class="ds-card__body">
        <div class="overflow-x-auto">
            <table id="d6-verify" class="ds-table w-full">
              <thead><tr><th>Element</th><th>Verified (Y/N)</th><th>Comments</th><th class="w-12"></th></tr></thead>
              <tbody></tbody>
              <tfoot><tr><td colspan="4"><button class="add-row-btn ds-btn ds-btn--tertiary w-full"><i data-lucide="plus"></i> Add Verification Item</button></td></tr></tfoot>
              <template>
                <tr>
                    <td><input class="ds-input" placeholder="e.g., No failures in 1000 cycles"/></td>
                    <td><select class="ds-select"><option>Yes</option><option>No</option></select></td>
                    <td><input class="ds-input" placeholder="Notes..."/></td>
                    <td><button class="remove-row-btn ds-btn-icon ds-btn-icon--danger"><i data-lucide="trash-2"></i></button></td>
                </tr>
              </template>
            </table>
        </div>
        <div class="mt-4 flex items-center justify-between">
            <div id="d6-approval-status" class="text-sm text-slate-500"></div>
            <button id="d6-approve" class="ds-btn ds-btn--primary">
                <i data-lucide="check-circle"></i>
                <span>Manager Sign-off</span>
            </button>
        </div>
    </div>
     <div class="ds-card__body border-t border-slate-200">
        <label class="ds-caption" for="d6-docs">6F. Supporting Documents</label>
        <input id="d6-docs" class="ds-input preview-file mt-1" type="file" multiple />
        <div class="file-preview mt-2"></div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script>
(function() {
    if (window.d6Initialized) return;
    window.d6Initialized = true;

    function qs(selector, context = document) { return context.querySelector(selector); }
    function qsa(selector, context = document) { return Array.from(context.querySelectorAll(selector)); }

    function updateAppData() {
        if (!window.app || !window.app.data || !window.app.data.d6) return;
        const fields = window.app.data.d6.fields;

        fields.implementationTracking = qsa('#d6-impl tbody tr').map(tr => ({
            action: qs('.impl-action', tr)?.value || '',
            targetDate: qs('input[type="date"]', tr)?.value || '',
            proofingType: qs('select:nth-of-type(1)', tr)?.value || 'Detection',
            proofingLevel: qs('input[type="number"]:nth-of-type(1)', tr)?.value || '',
            proofingImpact: qs('input[type="number"]:nth-of-type(2)', tr)?.value || '',
            appliedToSimilar: qs('select:nth-of-type(2)', tr)?.value || 'No',
            qtyParts: qs('input[type="number"]:nth-of-type(3)', tr)?.value || '',
            qtyPlaces: qs('input[type="number"]:nth-of-type(4)', tr)?.value || '',
            responsibility: qs('td:nth-of-type(10) input', tr)?.value || '',
            effectiveness: qs('td:nth-of-type(11) input', tr)?.value || '',
            status: qs('td:nth-of-type(12) select', tr)?.value || 'Open'
        }));

        fields.verificationItems = qsa('#d6-verify tbody tr').map(tr => ({
            element: qs('input:nth-of-type(1)', tr)?.value || '',
            verified: qs('select', tr)?.value || 'No',
            comments: qs('input:nth-of-type(2)', tr)?.value || ''
        }));

        fields.proof = qs('#d6-proof')?.value || '';
        fields.situationAfter = qs('#d6-situationAfter')?.value || '';

        window.app._dirty = true;
        if (window.app.updateSaveFab) window.app.updateSaveFab(true);
        if (window.app.saveData) {
            clearTimeout(window.d6SaveTimer);
            window.d6SaveTimer = setTimeout(() => window.app.saveData('d6-update'), 600);
        }
    }

    function initializeD6Logic(context) {
        function render() {
            if (!window.app || !window.app.data || !window.app.data.d6) return;
            const fields = window.app.data.d6.fields;

            if (!fields.implementationTracking) {
                 fields.implementationTracking = (window.app.data.d5?.fields?.correctiveActions || [])
                    .filter(a => a.status === 'Verified' || a.status === 'Completed')
                    .map(a => ({
                        action: a.action,
                        targetDate: a.targetDate,
                        proofingType: 'Control',
                        proofingLevel: 4,
                        proofingImpact: 4,
                        appliedToSimilar: 'Yes',
                        qtyParts: 1,
                        qtyPlaces: 1,
                        responsibility: a.responsibility,
                        effectiveness: '',
                        status: 'In Progress'
                    }));
            }
            if (!fields.verificationItems) {
                fields.verificationItems = [
                    { element: 'Control Plan Updated', verified: 'Yes', comments: 'CP-112 Rev B issued.'},
                    { element: 'PFMEA Updated', verified: 'Yes', comments: 'PFMEA-Z-80 RPN reduced from 320 to 80.'},
                    { element: 'No failures in 1000-part validation run', verified: 'Yes', comments: 'Validation report VAL-2024-08-15 attached.'}
                ];
            }

            const implTbody = qs('#d6-impl tbody', context);
            const implTemplate = qs('#d6-impl template', context);
            if (implTbody && implTemplate && fields.implementationTracking) {
                implTbody.innerHTML = '';
                fields.implementationTracking.forEach(item => {
                    const row = implTemplate.content.cloneNode(true);
                    qs('.impl-action', row).value = item.action || '';
                    qs('input[type="date"]', row).value = item.targetDate || '';
                    qs('select:nth-of-type(1)', row).value = item.proofingType || 'Detection';
                    qs('input[type="number"]:nth-of-type(1)', row).value = item.proofingLevel || '';
                    qs('input[type="number"]:nth-of-type(2)', row).value = item.proofingImpact || '';
                    qs('select:nth-of-type(2)', row).value = item.appliedToSimilar || 'No';
                    qs('input[type="number"]:nth-of-type(3)', row).value = item.qtyParts || '';
                    qs('input[type="number"]:nth-of-type(4)', row).value = item.qtyPlaces || '';
                    qs('td:nth-of-type(10) input', row).value = item.responsibility || '';
                    qs('td:nth-of-type(11) input', row).value = item.effectiveness || '';
                    qs('td:nth-of-type(12) select', row).value = item.status || 'Open';
                    implTbody.appendChild(row);
                });
            }

            const verifyTbody = qs('#d6-verify tbody', context);
            const verifyTemplate = qs('#d6-verify template', context);
            if (verifyTbody && verifyTemplate && fields.verificationItems) {
                verifyTbody.innerHTML = '';
                fields.verificationItems.forEach(item => {
                    const row = verifyTemplate.content.cloneNode(true);
                    qs('input:nth-of-type(1)', row).value = item.element || '';
                    qs('select', row).value = item.verified || 'No';
                    qs('input:nth-of-type(2)', row).value = item.comments || '';
                    verifyTbody.appendChild(row);
                });
            }

            qs('#d6-proof').value = fields.proof || '';
            qs('#d6-situationAfter').value = fields.situationAfter || '';
        }

        function attachListeners(context) {
            const container = qs('.space-y-6', context);
            if (!container || container.dataset.d6ListenersAttached) return;

            container.addEventListener('click', e => {
                const addBtn = e.target.closest('.add-row-btn');
                const removeBtn = e.target.closest('.remove-row-btn');

                if (addBtn) {
                    const table = addBtn.closest('table');
                    const template = qs('template', table);
                    if (template) {
                        const newRow = template.content.cloneNode(true);
                        qs('tbody', table).appendChild(newRow);
                        updateAppData();
                    }
                }

                if (removeBtn) {
                    if (confirm('Are you sure you want to remove this item?')) {
                        removeBtn.closest('tr').remove();
                        updateAppData();
                    }
                }
            });

            container.addEventListener('input', e => {
                updateAppData();
            });

            container.dataset.d6ListenersAttached = 'true';
        }

        render();
        attachListeners(context);
    }

    const originalInit = window.__init8D;
    window.__init8D = function(context) {
        if (originalInit) originalInit(context);
        if (qs('#d6-impl', context)) {
            initializeD6Logic(context);
        }
    };

    if (qs('#d6-impl')) {
        initializeD6Logic(document);
    }
})();
</script>