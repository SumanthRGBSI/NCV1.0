<!-- D7 — Prevent Recurrence -->
<div class="space-y-6" x-data="{ expandedAction: null }">

  <!-- Preventive Actions Card -->
  <div class="ds-card">
    <div class="ds-card__header">
      <h3 class="ds-h3">Preventive Actions</h3>
      <p class="ds-caption">Define systemic changes to prevent recurrence of this and similar problems.</p>
    </div>
    <div class="ds-card__body">
      <div class="overflow-x-auto">
        <table id="d7-prevent-slim" class="ds-table w-full">
          <thead>
            <tr>
              <th>Action</th>
              <th>Owner</th>
              <th>Due Date</th>
              <th>Status</th>
              <th class="w-28 text-right"></th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr><td colspan="5"><button class="add-row-btn ds-btn ds-btn--tertiary w-full"><i data-lucide="plus"></i> New Preventive Action</button></td></tr>
          </tfoot>
          <template>
            <tr class="d7-row">
              <td><input class="ds-input d7-action" placeholder="Describe the preventive action..."/></td>
              <td><input class="ds-input d7-owner" placeholder="Owner's name"/></td>
              <td><input class="ds-input d7-date" type="date"/></td>
              <td>
                <select class="ds-select prevent-status">
                  <option>Planned</option>
                  <option>In Progress</option>
                  <option>Done</option>
                </select>
              </td>
              <td class="text-right">
                <button class="ds-btn ds-btn--secondary d7-expand">Details</button>
              </td>
            </tr>
          </template>
        </table>
      </div>
    </div>
  </div>

  <!-- Action Details Card -->
  <div id="d7-detail" class="ds-card" style="display:none;">
    <div class="ds-card__header flex justify-between items-center">
        <h3 class="ds-h3">Action Details</h3>
        <button class="ds-btn-icon" onclick="document.getElementById('d7-detail').style.display='none'"><i data-lucide="x"></i></button>
    </div>
    <div class="ds-card__body grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- RPN & Type -->
      <div class="space-y-4">
        <div>
          <div class="flex items-center gap-2">
            <label class="ds-caption">Revised RPN (Severity, Occurrence, Detection)</label>
            <div class="ds-help">
              <i data-lucide="help-circle" class="w-4 h-4 ds-help__icon"></i>
              <div class="ds-help__tooltip">Risk Priority Number = Severity × Occurrence × Detection</div>
            </div>
          </div>
          <div class="grid grid-cols-3 gap-2 mt-1">
            <input class="ds-input rpn-s" type="number" min="1" max="10" placeholder="S"/>
            <input class="ds-input rpn-o" type="number" min="1" max="10" placeholder="O"/>
            <input class="ds-input rpn-d" type="number" min="1" max="10" placeholder="D"/>
          </div>
          <div class="text-sm mt-2">Revised RPN Score: <strong id="d7-rpn-val" class="font-bold text-slate-800">0</strong></div>
        </div>
        <div>
          <label class="ds-caption" for="d7-type">Action Type</label>
          <select id="d7-type" class="ds-select d7-type mt-1">
            <option selected>Prevent</option>
            <option>Detect</option>
            <option>Control</option>
            <option>Training</option>
            <option>Other</option>
          </select>
        </div>
        <div>
          <label class="ds-caption">Supporting Documents</label>
          <input class="ds-input preview-file mt-1" type="file" multiple />
          <div class="file-preview mt-2"></div>
        </div>
      </div>
      <!-- Related Standards -->
      <div>
        <label class="ds-caption">Related Standards (FMEA, Control Plan, SOPs)</label>
        <div id="d7-std-list" class="mt-1 p-2 bg-slate-50 rounded-lg min-h-[150px]">
          <!-- Related standards list will be injected by JS -->
        </div>
      </div>
    </div>
  </div>

  <!-- Acknowledgement Card -->
  <div class="ds-card">
    <div class="ds-card__header">
      <h3 class="ds-h3">Read & Understood</h3>
    </div>
    <div class="ds-card__body flex justify-between items-center">
      <div class="flex items-center gap-2">
        <div id="d7-avatar-stack" class="flex -space-x-2">
            <!-- Avatars will be injected by JS -->
        </div>
        <div id="d7-ack-bar" class="text-sm text-slate-600">0 of 0 acknowledged</div>
      </div>
      <button id="d7-view-acks" class="ds-btn ds-btn--secondary"><i data-lucide="users"></i> View Details</button>
    </div>
  </div>
</div>

<!-- Acknowledgement Modal -->
<div id="d7-ack-modal" class="fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50 hidden">
  <div class="ds-card w-full max-w-lg">
    <div class="ds-card__header flex justify-between items-center">
      <h3 class="ds-h3">Acknowledgement Status</h3>
      <button id="d7-modal-close" class="ds-btn-icon" aria-label="Close">
        <i data-lucide="x"></i>
      </button>
    </div>
    <div class="ds-card__body max-h-[60vh] overflow-y-auto">
      <ul id="d7-ack-list" class="space-y-2">
        <!-- List items will be injected by JS -->
      </ul>
    </div>
    <div class="ds-card__body border-t flex justify-end">
      <button id="d7-ack-me" class="ds-btn ds-btn--primary">Acknowledge Now</button>
    </div>
  </div>
</div>


<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script>
  if (window.__init8D) {
    window.__init8D(document);
  }

  (function() {
    // Function to calculate the revised RPN score in the D7 details card
    function calculateD7Rpn() {
      const detailCard = document.getElementById('d7-detail');
      if (!detailCard) return;

      const s = parseInt(detailCard.querySelector('.rpn-s')?.value, 10) || 0;
      const o = parseInt(detailCard.querySelector('.rpn-o')?.value, 10) || 0;
      const d = parseInt(detailCard.querySelector('.rpn-d')?.value, 10) || 0;
      const scoreEl = detailCard.querySelector('#d7-rpn-val');

      if (scoreEl) {
        scoreEl.textContent = s * o * d;
      }
    }

    // Use event delegation on the details card to listen for input changes
    const detailCard = document.getElementById('d7-detail');
    if (detailCard) {
      detailCard.addEventListener('input', function(event) {
        const target = event.target;
        if (target.matches('.rpn-s, .rpn-o, .rpn-d')) {
          calculateD7Rpn();
        }
      });
    }

    // Also, ensure the calculation runs when the details card is shown,
    // in case it's populated with data before being displayed.
    const observer = new MutationObserver(function(mutations) {
        for (let mutation of mutations) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                if (detailCard.style.display !== 'none') {
                    calculateD7Rpn();
                }
            }
        }
    });

    if(detailCard) {
      observer.observe(detailCard, { attributes: true });
    }

    // --- Acknowledgement Tracking Logic ---
    const ackModal = document.getElementById('d7-ack-modal');
    const viewBtn = document.getElementById('d7-view-acks');
    const closeBtn = document.getElementById('d7-modal-close');
    const ackMeBtn = document.getElementById('d7-ack-me');
    const ackList = document.getElementById('d7-ack-list');
    const ackBar = document.getElementById('d7-ack-bar');
    const avatarStack = document.getElementById('d7-avatar-stack');

    if (ackModal && viewBtn && closeBtn && ackMeBtn && ackList && ackBar && avatarStack) {
      // This would normally come from window.app.data.d7.acknowledgements
      let acknowledgements = new Set(['samantha.jones@example.com']);

      // This would come from window.app.data.d1.fields.members
      const teamMembers = [
        { name: 'Alex Vance', email: 'alex.vance@example.com' },
        { name: 'Samantha Jones', email: 'samantha.jones@example.com' },
        { name: 'Brad Carter', email: 'brad.carter@example.com' },
        { name: 'Maria Garcia', email: 'maria.garcia@example.com' },
      ];

      // Assuming the current user's email is stored somewhere, e.g., localStorage
      const currentUserEmail = 'alex.vance@example.com';

      function renderAckStatus() {
        // Render modal list
        ackList.innerHTML = '';
        teamMembers.forEach(member => {
          const isAcked = acknowledgements.has(member.email);
          const li = document.createElement('li');
          li.className = 'flex items-center justify-between p-2 rounded-md';
          li.innerHTML = `
            <span class="font-semibold text-slate-700">${member.name}</span>
            ${isAcked
              ? '<span class="flex items-center gap-1 text-emerald-600"><i data-lucide="check-circle-2" class="w-4 h-4"></i>Acknowledged</span>'
              : '<span class="text-xs text-slate-500">Pending</span>'
            }
          `;
          ackList.appendChild(li);
        });

        // Render summary bar
        ackBar.textContent = `${acknowledgements.size} of ${teamMembers.length} acknowledged`;

        // Render avatar stack
        avatarStack.innerHTML = '';
        teamMembers.filter(m => acknowledgements.has(m.email)).slice(0, 5).forEach(m => {
          const initials = m.name.split(' ').map(n => n[0]).join('');
          const span = document.createElement('span');
          span.className = 'inline-flex items-center justify-center h-8 w-8 rounded-full bg-emerald-200 text-emerald-700 font-bold text-xs ring-2 ring-white';
          span.textContent = initials;
          span.title = m.name;
          avatarStack.appendChild(span);
        });

        // Update button state
        ackMeBtn.disabled = acknowledgements.has(currentUserEmail);
        ackMeBtn.textContent = acknowledgements.has(currentUserEmail) ? 'Acknowledged' : 'Acknowledge Now';

        if(window.lucide) window.lucide.createIcons();
      }

      viewBtn.addEventListener('click', () => {
        renderAckStatus();
        ackModal.classList.remove('hidden');
      });

      closeBtn.addEventListener('click', () => ackModal.classList.add('hidden'));
      ackModal.addEventListener('click', (e) => {
        if (e.target === ackModal) ackModal.classList.add('hidden');
      });

      ackMeBtn.addEventListener('click', () => {
        if (!acknowledgements.has(currentUserEmail)) {
          acknowledgements.add(currentUserEmail);
          // In a real app, you would save this back to window.app.data
          renderAckStatus();
        }
      });

      // Initial render for the summary bar
      renderAckStatus();
    }
  })();
</script>