<!-- D4 â€” Root Cause Analysis -->
<div class="space-y-6" x-data="{ activeTab: 'fishbone' }">

  <!-- Root Cause Tools Card -->
  <div class="ds-card">
    <div class="ds-card__header">
      <h3 class="ds-h3">4A. Root Cause Analysis Tools</h3>
    </div>
    <!-- Tabs -->
    <div class="border-b border-slate-200 px-6">
        <nav class="flex -mb-px space-x-6">
            <button @click="activeTab = 'fishbone'" :class="{'border-primary-500 text-primary-600 font-semibold': activeTab === 'fishbone'}" class="px-1 py-3 text-sm border-b-2 transition-colors">Fishbone Diagram</button>
            <button @click="activeTab = 'whys'" :class="{'border-primary-500 text-primary-600 font-semibold': activeTab === 'whys'}" class="px-1 py-3 text-sm border-b-2 transition-colors">5 Whys</button>
            <button @click="activeTab = 'causes'" :class="{'border-primary-500 text-primary-600 font-semibold': activeTab === 'causes'}" class="px-1 py-3 text-sm border-b-2 transition-colors">Potential Causes</button>
        </nav>
    </div>
    <div class="ds-card__body">
      <!-- Fishbone Panel -->
      <div x-show="activeTab === 'fishbone'">
        <p class="ds-caption mb-4">Click a bone on the diagram to add a potential cause, or add it directly to the table below.</p>
        <div id="d4-fishbone-canvas" class="p-4 bg-slate-50 rounded-lg min-h-[200px]">
          <!-- Fishbone diagram will be rendered here by JS -->
        </div>
        <div class="overflow-x-auto mt-4">
          <table id="d4-fishbone-table" class="ds-table w-full">
            <thead><tr><th>Category</th><th>Potential Cause</th><th>Evidence/Notes</th><th class="w-12"></th></tr></thead>
            <tbody></tbody>
            <tfoot><tr><td colspan="4"><button class="add-row-btn ds-btn ds-btn--tertiary w-full"><i data-lucide="plus"></i> Add Cause</button></td></tr></tfoot>
            <template>
              <tr>
                <td><select class="ds-select"><option>Man</option><option>Machine</option><option>Method</option><option>Material</option><option>Measurement</option><option>Environment</option></select></td>
                <td><input class="ds-input d4-cause-text"/></td>
                <td><input class="ds-input"/></td>
                <td><button class="remove-row-btn ds-btn-icon ds-btn-icon--danger"><i data-lucide="trash-2"></i></button></td>
              </tr>
            </template>
          </table>
        </div>
      </div>
      <!-- 5 Whys Panel -->
      <div x-show="activeTab === 'whys'">
        <div class="flex items-end gap-2 mb-4">
            <div class="flex-grow">
                <label for="d4-why-target" class="ds-caption">Link to a potential cause from the Fishbone analysis</label>
                <input id="d4-why-target" class="ds-input" placeholder="e.g., Operator fatigue"/>
            </div>
            <button id="d4-start-whys" class="ds-btn ds-btn--secondary"><i data-lucide="play"></i> Start 5 Whys</button>
        </div>
        <div id="d4-fivewhys" class="space-y-3">
          <!-- 5 Whys analysis will be injected here by JS -->
        </div>
      </div>
      <!-- Potential Causes Panel -->
      <div x-show="activeTab === 'causes'">
         <p class="ds-caption mb-2">This is a collection of all potential causes identified in the tools above.</p>
         <div id="d4-cause-list" class="space-y-2">
           <!-- Potential causes list will be injected here by JS -->
         </div>
      </div>
    </div>
  </div>

  <!-- Examples Card -->
  <details class="ds-card bg-slate-50 overflow-hidden">
    <summary class="ds-card__header cursor-pointer flex justify-between items-center">
        <h3 class="ds-h3 text-base">Examples</h3>
        <i data-lucide="chevron-down" class="transition-transform duration-300 group-open:rotate-180"></i>
    </summary>
    <div class="ds-card__body grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <h4 class="font-bold text-sm text-slate-700">Sample Fishbone (6M)</h4>
            <svg viewBox="0 0 700 220" width="100%" height="220" aria-label="Fishbone Sample" class="mt-2">
              <line x1="40" y1="110" x2="660" y2="110" stroke="#334155" stroke-width="3"/>
              <polygon points="660,110 640,100 640,120" fill="#334155"/>
              <line x1="140" y1="110" x2="220" y2="60" stroke="#64748b" stroke-width="2"/><text x="225" y="58" font-size="12" fill="#0f172a">Man</text>
              <line x1="260" y1="110" x2="340" y2="60" stroke="#64748b" stroke-width="2"/><text x="345" y="58" font-size="12" fill="#0f172a">Machine</text>
              <line x1="380" y1="110" x2="460" y2="60" stroke="#64748b" stroke-width="2"/><text x="465" y="58" font-size="12" fill="#0f172a">Method</text>
              <line x1="140" y1="110" x2="220" y2="160" stroke="#64748b" stroke-width="2"/><text x="225" y="170" font-size="12" fill="#0f172a">Material</text>
              <line x1="260" y1="110" x2="340" y2="160" stroke="#64748b" stroke-width="2"/><text x="345" y="170" font-size="12" fill="#0f172a">Measurement</text>
              <line x1="380" y1="110" x2="460" y2="160" stroke="#64748b" stroke-width="2"/><text x="465" y="170" font-size="12" fill="#0f172a">Environment</text>
              <text x="60" y="105" font-size="13" fill="#0f172a">Effect / Problem</text>
            </svg>
        </div>
        <div>
            <h4 class="font-bold text-sm text-slate-700">Sample 5 Whys</h4>
            <ol class="list-decimal list-inside text-sm text-slate-600 space-y-1 mt-2">
              <li><strong>Why 1:</strong> Process output failed spec due to excess variation.</li>
              <li><strong>Why 2:</strong> Variation increased because fixture alignment drifts.</li>
              <li><strong>Why 3:</strong> Alignment drifts because set screws loosen.</li>
              <li><strong>Why 4:</strong> Set screws loosen because torque was below spec.</li>
              <li><strong>Why 5:</strong> Torque below spec because SOP lacks torque verification step.</li>
            </ol>
        </div>
    </div>
  </details>

  <!-- Verification Card -->
  <div class="ds-card">
    <div class="ds-card__header">
      <h3 class="ds-h3">Verify Potential Root Causes</h3>
    </div>
    <div class="ds-card__body space-y-6">
      <div>
        <h4 class="font-semibold text-slate-700">Verification Actions</h4>
        <div class="overflow-x-auto mt-2">
            <table class="ds-table w-full">
              <thead><tr><th>Action</th><th>Responsibility</th><th>Target Date</th><th>Status</th><th class="w-12"></th></tr></thead>
              <tbody></tbody>
              <tfoot><tr><td colspan="5"><button class="add-row-btn ds-btn ds-btn--tertiary w-full"><i data-lucide="plus"></i> Add Verification Action</button></td></tr></tfoot>
              <template><tr><td><input class="ds-input"/></td><td><input class="ds-input"/></td><td><input class="ds-input" type="date"/></td><td><input class="ds-input"/></td><td><button class="remove-row-btn ds-btn-icon ds-btn-icon--danger"><i data-lucide="trash-2"></i></button></td></tr></template>
            </table>
        </div>
      </div>
      <div>
        <label class="ds-caption" for="d4-verificationSummary">4D. Summary of Root Cause Verifications</label>
        <textarea id="d4-verificationSummary" class="ds-textarea" placeholder="Summarize the findings from the verification actions..."></textarea>
      </div>
      <div>
        <h4 class="font-semibold text-slate-700">4E. Final Root Cause(s)</h4>
        <div class="overflow-x-auto mt-2">
            <table id="d4-root-causes" class="ds-table w-full">
              <thead><tr><th>Root Cause</th><th>Category</th><th>Likelihood (1-5)</th><th>Severity (1-5)</th><th>Score</th><th>Link to D5</th><th class="w-12"></th></tr></thead>
              <tbody></tbody>
              <tfoot><tr><td colspan="7"><button class="add-row-btn ds-btn ds-btn--tertiary w-full"><i data-lucide="plus"></i> Add Root Cause</button></td></tr></tfoot>
              <template>
                <tr>
                  <td><input class="ds-input rc-text"/></td>
                  <td><select class="ds-select"><option>Process</option><option>Design</option><option>Materials</option><option>Human</option><option>Other</option></select></td>
                  <td><select class="ds-select rc-like"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select></td>
                  <td><select class="ds-select rc-sev"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select></td>
                  <td><input class="ds-input rc-score" type="number" disabled /></td>
                  <td><button type="button" class="ds-btn ds-btn--secondary rc-link w-full"><i data-lucide="link"></i> Link</button></td>
                  <td><button class="remove-row-btn ds-btn-icon ds-btn-icon--danger"><i data-lucide="trash-2"></i></button></td>
                </tr>
              </template>
            </table>
        </div>
      </div>
    </div>
     <div class="ds-card__body border-t border-slate-200">
        <label class="ds-caption" for="d4-docs">4F. Supporting Documents</label>
        <input id="d4-docs" class="ds-input preview-file mt-1" type="file" multiple />
        <div class="file-preview mt-2"></div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script>
  if (window.__init8D) {
    window.__init8D(document);
  }
</script>