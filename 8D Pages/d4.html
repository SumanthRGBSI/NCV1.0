<section class="container">
  <link rel="stylesheet" href="/assets/8d.css">
  <div class="card header toolbar">
    <div>
      <div class="h-title">D4 â€” Root Cause Analysis ðŸ”¬</div>
      <div class="h-sub">Identify and verify the true root cause of the problem.</div>
    </div>
    <div class="controls">
      <div class="timestamp">Last updated: <span id="d4-timestamp">Never</span></div>
      <select id="d4-status-select" class="input select-compact status-select" data-id="d4">
        <option value="pending">Pending</option>
        <option value="in-progress">In Progress</option>
        <option value="completed">Completed</option>
      </select>
      <button class="btn btn-primary save-btn" data-id="d4"><i class="fas fa-save"></i> Save</button>
    </div>
  </div>

  <div class="card">
    <div class="controls flex-between">
      <div class="section-title">4A. Cause & Effect (Fishbone)</div>
      <div class="small">Brainstorm potential causes across the 6Ms</div>
    </div>
    <div class="row">
      <div class="col">
        <button class="btn btn-ghost" id="launch-fishbone">Open Fishbone Tool</button>
        <button class="btn btn-ghost" id="launch-5whys">Start 5 Whys Guide</button>
      </div>
      <div class="col">
        <label class="label">4B. 5 Why Analysis (Occurrence)</label>
        <div id="d4-fivewhys" class="dynamic-list"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <details>
      <summary class="section-title">Show Example</summary>
    <div class="hint">Use these references as a guide. Replace with your investigation.</div>
    <div class="row mt-small">
      <div class="col">
        <div class="small">Sample Fishbone (6M)</div>
        <svg viewBox="0 0 700 220" width="100%" height="220" aria-label="Fishbone Sample">
          <line x1="40" y1="110" x2="660" y2="110" stroke="#334155" stroke-width="3"/>
          <polygon points="660,110 640,100 640,120" fill="#334155"/>
          <!-- Upper branches -->
          <line x1="140" y1="110" x2="220" y2="60" stroke="#64748b" stroke-width="2"/>
          <text x="225" y="58" font-size="12" fill="#0f172a">Man</text>
          <line x1="260" y1="110" x2="340" y2="60" stroke="#64748b" stroke-width="2"/>
          <text x="345" y="58" font-size="12" fill="#0f172a">Machine</text>
          <line x1="380" y1="110" x2="460" y2="60" stroke="#64748b" stroke-width="2"/>
          <text x="465" y="58" font-size="12" fill="#0f172a">Method</text>
          <!-- Lower branches -->
          <line x1="140" y1="110" x2="220" y2="160" stroke="#64748b" stroke-width="2"/>
          <text x="225" y="170" font-size="12" fill="#0f172a">Material</text>
          <line x1="260" y1="110" x2="340" y2="160" stroke="#64748b" stroke-width="2"/>
          <text x="345" y="170" font-size="12" fill="#0f172a">Measurement</text>
          <line x1="380" y1="110" x2="460" y2="160" stroke="#64748b" stroke-width="2"/>
          <text x="465" y="170" font-size="12" fill="#0f172a">Environment</text>
          <text x="60" y="105" font-size="13" fill="#0f172a">Effect / Problem</text>
        </svg>
      </div>
      <div class="col">
        <div class="small">Sample 5 Whys</div>
        <ol class="small">
          <li><strong>Why 1:</strong> Process output failed spec due to excess variation.</li>
          <li><strong>Why 2:</strong> Variation increased because fixture alignment drifts.</li>
          <li><strong>Why 3:</strong> Alignment drifts because set screws loosen.</li>
          <li><strong>Why 4:</strong> Set screws loosen because torque was below spec.</li>
          <li><strong>Why 5:</strong> Torque below spec because SOP lacks torque verification step.</li>
        </ol>
      </div>
    </div>
    </details>
  </div>

  <div class="card">
    <div class="section-title">Verify Potential Root Causes <span class="badge badge-pending" id="d4-verify-badge">Guide</span></div>
    <table class="table dynamic-table">
      <thead><tr><th>Action</th><th>Responsibility</th><th>Target Date</th><th>Status</th><th></th></tr></thead>
      <tbody></tbody>
      <tfoot><tr><td colspan="5"><button class="add-row-btn btn btn-ghost">Add Verification Action</button></td></tr></tfoot>
      <template><tr><td><input class="input"/></td><td><input class="input"/></td><td><input class="input" type="date"/></td><td><input class="input"/></td><td><button class="remove-row-btn btn btn-danger">Remove</button></td></tr></template>
    </table>

    <label class="label mt-small">4D. Summary of Root Cause Verifications</label>
    <textarea id="d4-verificationSummary" class="input"></textarea>

    <div class="small mt-small">4E. Final Root Cause</div>
    <table id="d4-root-causes" class="table dynamic-table">
      <thead><tr><th>Root Cause</th><th>Category</th><th>Likelihood (1-5)</th><th>Severity (1-5)</th><th>Score</th><th>Link to D5</th><th></th></tr></thead>
      <tbody></tbody>
      <tfoot><tr><td colspan="7"><button class="add-row-btn btn btn-ghost">Add Root Cause</button></td></tr></tfoot>
      <template>
        <tr>
          <td><input class="input rc-text"/></td>
          <td><select class="input"><option>Process</option><option>Design</option><option>Materials</option><option>Human</option><option>Other</option></select></td>
          <td><select class="input rc-like"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select></td>
          <td><select class="input rc-sev"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select></td>
          <td><input class="input rc-score" type="number" disabled /></td>
          <td><button type="button" class="btn btn-ghost rc-link">Link</button></td>
          <td><button class="remove-row-btn btn btn-danger">Remove</button></td>
        </tr>
      </template>
    </table>

    <div class="mt-small">
      <label class="label">4F. Documents</label>
      <input class="preview-file" type="file" multiple />
    </div>
  </div>

  <script src="/assets/8d-forms.js"></script>
  <script>
    window.__init8D && window.__init8D(document);
    document.getElementById('launch-fishbone')?.addEventListener('click', ()=>{
      const modal = document.createElement('div');
      modal.innerHTML = `
        <div id="fb-modal" class="modal-overlay">
          <div class="card modal-card">
            <div class="flex-between">
              <div class="h-title">Fishbone Brainstorm</div>
              <div class="controls"><button class="icon-btn" id="fb-close" aria-label="Close">âœ•</button></div>
            </div>
            <div class="small mt-small">Use the 6M tabs to focus your brainstorming.</div>
            <div class="controls mt-xs" id="fb-tabs">
              <button class="btn btn-ghost fb-tab" data-cat="Man">Man</button>
              <button class="btn btn-ghost fb-tab" data-cat="Machine">Machine</button>
              <button class="btn btn-ghost fb-tab" data-cat="Method">Method</button>
              <button class="btn btn-ghost fb-tab" data-cat="Material">Material</button>
              <button class="btn btn-ghost fb-tab" data-cat="Measurement">Measurement</button>
              <button class="btn btn-ghost fb-tab" data-cat="Environment">Environment</button>
            </div>
            <table class="table dynamic-table" id="fb-table">
              <thead><tr><th>Category</th><th>Potential Cause</th><th>Evidence/Notes</th><th></th></tr></thead>
              <tbody></tbody>
              <tfoot><tr><td colspan="4"><button class="add-row-btn btn btn-ghost">Add Cause</button></td></tr></tfoot>
              <template><tr><td><select class="input"><option>Man</option><option>Machine</option><option>Method</option><option>Material</option><option>Measurement</option><option>Environment</option></select></td><td><input class="input"/></td><td><input class="input"/></td><td><button class="remove-row-btn btn btn-danger">Remove</button></td></tr></template>
            </table>
          </div>
        </div>`;
      document.body.appendChild(modal);
      window.__init8D && window.__init8D(document.getElementById('fb-modal'));
      const tabs = modal.querySelectorAll('.fb-tab');
      tabs.forEach(btn=> btn.addEventListener('click', ()=>{
        const cat = btn.dataset.cat;
        const sel = modal.querySelectorAll('#fb-table tbody tr select');
        sel.forEach(s=>{ if(s && s.value!==cat) s.value = cat; });
      }));
      modal.addEventListener('click', (e)=>{ if(e.target.id==='fb-modal' || e.target.id==='fb-close'){ modal.remove(); } });
    });

    document.getElementById('launch-5whys')?.addEventListener('click', ()=>{
      const host = document.getElementById('d4-fivewhys');
      if(!host) return;
      host.innerHTML = '';
      for(let i=1;i<=5;i++){
        const wrap = document.createElement('div');
        wrap.className = 'row mt-xs';
        wrap.innerHTML = `<div class="col"><label class="label">Why ${i}</label><input class="input why-input" data-idx="${i}" ${i>1?'disabled':''} placeholder="Enter reason ${i}"></div>`;
        host.appendChild(wrap);
      }
      const inputs = host.querySelectorAll('.why-input');
      inputs.forEach(inp=> inp.addEventListener('input', ()=>{
        const idx = parseInt(inp.dataset.idx,10);
        const next = host.querySelector(`.why-input[data-idx="${idx+1}"]`);
        if(next){ next.disabled = inp.value.trim().length === 0; }
      }));
    });
  </script>
</section>
